<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Arcade Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>

        /* --- GLOBAL STYLES --- */
        :root {
            --primary: #0f212e;
            --secondary: #213743;
            --accent: #00e701;
            --danger: #ff4d4d;
            --text-main: #ffffff;
            --text-dim: #b1bad3;
            --header-h: 70px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #1a1a2e;
            background-image: radial-gradient(#1f2b4d 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: var(--header-h);
            padding-bottom: 50px;
        }

        .hidden { display: none !important; }
        .fade-out { opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        .fade-in { opacity: 1; transition: opacity 0.5s ease; }

        /* --- HEADER & NAV --- */
        .top-bar {
            width: 100%;
            height: var(--header-h);
            background: rgba(15, 33, 46, 0.98);
            backdrop-filter: blur(10px);
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            position: fixed;
            top: 0; left: 0; z-index: 1000;
            border-bottom: 1px solid #2f4553;
        }

        .nav-container { position: relative; height: 100%; display: flex; align-items: center; }
        .menu-btn {
            background: #213743; border: 1px solid #2f4553; color: #fff; font-size: 1rem; cursor: pointer;
            padding: 8px 15px; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
            height: 40px;
        }
        .menu-btn:hover { background: #2f4553; }
        
        .dropdown-content {
            display: none; position: absolute; left: 0; top: 100%; margin-top: 5px;
            background-color: var(--secondary); min-width: 200px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); border-radius: 12px;
            border: 1px solid #2f4553; overflow: hidden; z-index: 1001;
            animation: slideDown 0.1s ease-out;
        }
        .nav-container::after { content: ''; position: absolute; top: 100%; left: 0; width: 100%; height: 15px; } 
        .dropdown-content a {
            color: var(--text-dim); padding: 15px 20px; text-decoration: none;
            display: flex; align-items: center; gap: 10px;
            font-weight: 600; transition: 0.2s; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .dropdown-content a:last-child { border-bottom: none; }
        .dropdown-content a:hover { background-color: rgba(255,255,255,0.05); color: #fff; padding-left: 25px; }
        .nav-container:hover .dropdown-content { display: block; }

        .auth-btn {
            background: #00e701; color: #0f212e; border: none; padding: 8px 20px;
            border-radius: 20px; font-weight: bold; cursor: pointer; transition: transform 0.2s;
        }
        .auth-btn:hover { transform: scale(1.05); }

        .user-panel { display: flex; gap: 10px; align-items: center; }
        
        .balance-wrapper {
            background-color: #0f3460; padding: 8px 16px; border-radius: 50px;
            display: flex; align-items: center; gap: 15px; border: 1px solid #533483;
            box-shadow: 0 0 10px rgba(83, 52, 131, 0.3);
        }
        .balance-text { font-weight: 800; font-size: 1rem; letter-spacing: 0.5px; }
        .plus-btn {
            background: linear-gradient(135deg, #28a745, #218838); color: white; border: none;
            width: 24px; height: 24px; border-radius: 50%; font-size: 1.1rem; line-height: 0; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s; padding-bottom: 3px;
        }
        .plus-btn:hover { transform: scale(1.1); }

        /* --- SCREENS --- */
        .screen {
            width: 100%; max-width: 1200px; padding: 20px; text-align: center;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin: 0 auto;
        }

        /* --- HOME GRID --- */
        .home-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .game-card {
            background: linear-gradient(145deg, #16213e, #1f2b4d); border-radius: 20px; padding: 20px;
            cursor: pointer; border: 2px solid #533483; transition: all 0.2s; aspect-ratio: 1 / 1;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .game-card:hover { transform: translateY(-5px); border-color: #e94560; box-shadow: 0 15px 30px rgba(233, 69, 96, 0.2); }
        .game-card h3 { margin: 15px 0 5px 0; font-size: 1.3rem; }
        .game-card p { margin: 0; font-size: 0.9rem; color: #aaa; }

/* --- PROFIT-BASED RARITY GLOWS (SUPER BRIGHT) --- */
    
    /* 1. Define Colors */
    .rarity-gray      { --r-color: #b0c3d9; }
    .rarity-lightblue { --r-color: #4b69ff; }
    .rarity-blue      { --r-color: #0044ff; }
    .rarity-purple    { --r-color: #8847ff; }
    .rarity-pink      { --r-color: #d32ce6; }
    .rarity-red       { --r-color: #eb4b4b; }
    .rarity-gold      { --r-color: #ffd700; }

    .item-vertical, .item-horizontal {
        position: relative;
        border-bottom: 2px solid rgba(255,255,255,0.05) !important;
        background: transparent !important;
        overflow: visible !important; 
    }

    /* 2. THE GLOW (Stronger & Bigger) */
    .item-vertical::before, .item-horizontal::before {
        content: '';
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 85px; height: 85px; /* Bigger Glow */
        background: var(--r-color, transparent);
        filter: blur(22px); /* Concentrated light */
        opacity: 0.6; /* Much brighter default state */
        border-radius: 50%;
        z-index: 0;
        pointer-events: none;
        transition: opacity 0.3s, transform 0.3s;
    }

    /* 3. Text Coloring */
    .spinner-text-v div:last-child { 
        color: var(--r-color, #fff) !important; 
        text-shadow: 0 0 10px rgba(0,0,0,0.8);
        z-index: 2; position: relative;
    }
    .spinner-text-h { 
        color: var(--r-color, #fff) !important; 
        text-shadow: 0 0 5px rgba(0,0,0,0.8);
        z-index: 2; position: relative;
    }

    .item-vertical img, .item-horizontal img { position: relative; z-index: 1; }

    /* 4. WINNER STATE (Blinding Flash) */
    .item-vertical.winner-landed::before, .item-horizontal.winner-landed::before {
        opacity: 1.0 !important; /* Max brightness */
        transform: translate(-50%, -50%) scale(1.6); /* Massive burst */
        filter: blur(25px);
    }

    .item-vertical.winner-landed img, .item-horizontal.winner-landed img {
        transform: scale(1.15);
        filter: drop-shadow(0 0 15px var(--r-color));
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .rarity-gold .spinner-text-v div:last-child, .rarity-gold .spinner-text-h {
        text-shadow: 0 0 15px rgba(255, 215, 0, 1);
    }

        /* --- DICE GAME --- */
        .dice-layout { display: flex; gap: 20px; flex-wrap: wrap; text-align: left; }
        .dice-sidebar { 
            flex: 1 1 300px; background: #213743; padding: 25px; border-radius: 16px;
            display: flex; flex-direction: column; gap: 20px; height: fit-content;
        }
        .dice-main { 
            flex: 2 1 400px; background: #0f212e; padding: 40px; border-radius: 16px;
            display: flex; flex-direction: column; justify-content: center; min-height: 400px; position: relative;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }
        
        .dice-track-container { position: relative; width: 100%; height: 20px; margin: 60px 0; background: #2f4553; border-radius: 10px; }
        .dice-win-bar { 
            position: absolute; top: 0; right: 0; height: 100%; border-radius: 0 10px 10px 0;
            background: #00e701; width: 50%; pointer-events: none; box-shadow: 0 0 15px rgba(0,231,1,0.3);
        }
        input[type=range].dice-slider {
            -webkit-appearance: none; width: 100%; background: transparent; position: absolute; top: -10px; left: 0; height: 40px; z-index: 10; margin: 0;
        }
        input[type=range].dice-slider:focus { outline: none; }
        input[type=range].dice-slider::-webkit-slider-thumb {
            -webkit-appearance: none; height: 34px; width: 34px; border-radius: 8px;
            background: #fff; cursor: pointer; margin-top: 3px; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); border: 2px solid #b1bad3;
        }
        
        .dice-result-marker {
            position: absolute; top: -45px; width: 40px; height: 40px;
            background: #fff; border-radius: 8px; transform: translateX(-50%);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.9rem; color: #0f212e;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            opacity: 0; transition: left 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s;
            z-index: 5;
        }
        .dice-result-marker::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #fff;
        }
        .dice-labels { display: flex; justify-content: space-between; position: absolute; top: -30px; width: 100%; font-weight: bold; color: #5e7082; font-size: 0.9rem; }
        .dice-stat-row { display: flex; gap: 15px; background: #213743; padding: 20px; border-radius: 12px; margin-top: 50px; }
        .dice-stat-box { flex: 1; display: flex; flex-direction: column; gap: 5px; position: relative; }
        .dice-stat-label { font-size: 0.85rem; color: #8a9bb0; font-weight: bold; }
        .dice-stat-input { background: transparent; border: none; color: white; font-weight: bold; font-size: 1.1rem; width: 100%; padding: 0; }
        .dice-stat-input:focus { outline: none; border-bottom: 2px solid #00e701; }

        /* --- BATTLE CREATION --- */
        .battle-creation-dashboard {
            background: #0f212e; border-radius: 20px; padding: 25px; text-align: left; border: 1px solid #2f4553;
        }
        .bc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #2f4553; padding-bottom: 20px; }
        
        .bc-cart-area {
            background: #16213e; padding: 20px; border-radius: 15px; margin-bottom: 20px; min-height: 160px;
            display: flex; gap: 15px; overflow-x: auto; align-items: center;
        }
        .bc-cart-item {
            flex: 0 0 110px; height: 140px; background: #0f3460; border: 1px solid #533483; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .bc-cart-item img { width: 70px; height: 70px; object-fit: contain; margin-bottom: 5px; }
        .bc-badge {
            position: absolute; top: -5px; right: -5px; background: #e94560; color: #fff; 
            font-weight: bold; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        .bc-add-placeholder {
            flex: 0 0 110px; height: 140px; border: 2px dashed #533483; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; color: #533483; font-size: 2rem;
            cursor: pointer; transition: 0.2s;
        }
        .bc-add-placeholder:hover { border-color: #aaa; color: #aaa; }

        /* CASE SELECT MODAL ITEMS */
        .case-select-item {
            background: #0f3460; border: 1px solid #533483; padding: 10px; border-radius: 12px; 
            display: flex; flex-direction: column; align-items: center; overflow: hidden; position: relative;
            transition: all 0.2s;
        }
        .case-select-item:hover { border-color: #e94560; transform: translateY(-2px); }
        
        .case-inspect-btn {
            position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; cursor: pointer;
            background: rgba(0,0,0,0.6); border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; z-index: 10; transition: 0.2s;
        }
        .case-inspect-btn:hover { background: #fff; color: #000; }

        .case-controls {
            display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; width: 100%;
            background: rgba(0,0,0,0.3); padding: 5px; border-radius: 20px;
        }
        .ctrl-btn {
            width: 24px; height: 24px; background: #2f4553; border: none; color: #fff; border-radius: 4px;
            cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center;
        }
        .ctrl-btn:hover { background: #e94560; }
        .qty-display { font-weight: bold; min-width: 20px; text-align: center; font-size: 0.9rem; }

        /* --- UI UTILS --- */
        .btn { border: none; padding: 12px; font-size: 1rem; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 700; color: white; transition: background 0.2s; text-transform: uppercase; }
        .btn:disabled { background-color: #3b4a55 !important; color: #788691; cursor: not-allowed; opacity: 1; }
        .btn-primary { background: #00e701; color: #0f212e; } .btn-primary:hover { background: #00ff01; }
        .btn-secondary { background-color: #2f4553; } .btn-secondary:hover { background-color: #3e5868; }
        .btn-danger { background-color: #e91e63; }
        .btn-ghost { background: transparent; border: 1px solid #2f4553; color: #b1bad3; } .btn-ghost:hover { background: rgba(255,255,255,0.05); color: #fff; }
        
        .multi-control { display: flex; justify-content: center; gap: 5px; margin-bottom: 5px; background: #0f3460; padding: 5px; border-radius: 12px; display: inline-flex; }
        .multi-btn { background: transparent; border: none; color: #aaa; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s; font-size: 0.9rem; }
        .multi-btn.active { background: #e94560; color: white; }

        .input-group { background: #16213e; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; }
        .input-group label { color: #b1bad3; font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 8px; }
        input, select, textarea { width: 100%; padding: 10px; background: #0f212e; border: 2px solid #2f4553; color: white; border-radius: 4px; font-size: 1rem; box-sizing: border-box; font-weight: bold; font-family: monospace; }
        textarea { resize: vertical; min-height: 80px; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1a1a2e; border: 2px solid #533483; width: 90%; max-width: 800px; max-height: 80vh; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.6); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #533483; padding-bottom: 10px; }
        .case-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; overflow-y: auto; padding: 5px; }

        /* PROVABLY FAIR MODAL STYLES */
        .pf-field { margin-bottom: 15px; }
        .pf-field label { display: block; color: #8a9bb0; font-size: 0.8rem; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .pf-val-box { background: #0f212e; padding: 10px; border: 1px solid #2f4553; border-radius: 6px; font-family: monospace; word-break: break-all; color: #fff; font-size: 0.9rem; }
        .pf-row { display: flex; gap: 10px; align-items: center; }

        /* HISTORY FILTERS */
        .history-controls { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        .history-controls select { background: #16213e; color: #fff; border: 1px solid #2f4553; padding: 8px; border-radius: 8px; width: auto; font-size: 0.9rem; }
        
        .verify-btn { 
            background: transparent; border: 1px solid #00e701; color: #00e701; 
            padding: 4px 10px; border-radius: 5px; cursor: pointer; font-size: 0.75rem; font-weight: bold;
            transition: all 0.2s;
        }
        .verify-btn:hover { background: rgba(0, 231, 1, 0.1); }
        
        .rotate-btn-small {
            background: #2f4553; color: #fff; border: 1px solid #533483;
            padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; margin-left: 5px;
        }
        .blur { filter: blur(4px); user-select: none; opacity: 0.7; }

        /* CASES & SPINNING (LARGER REELS) */
        #case-opener { display: flex; flex-direction: column; gap: 20px; align-items: center; width: 100%; }
        #spinner-area { width: 100%; display: flex; justify-content: center; gap: 10px; overflow: hidden; }
        .viewport-horizontal { position: relative; width: 100%; height: 160px; background: #0a0a12; border: 3px solid #533483; border-radius: 12px; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.8); }
        .reel-horizontal { display: flex; position: absolute; left: 0; top: 0; height: 100%; will-change: transform; }
        .item-horizontal { min-width: 130px; max-width: 130px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 2px solid #1a1a2e; background: linear-gradient(180deg, #16213e 0%, #0f3460 100%); }
        .pointer-horizontal { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 4px; height: 100%; background: #fff; z-index: 100; box-shadow: 0 0 15px #fff; }
        
        /* UPDATED VERTICAL REELS (Bigger) */
        .viewport-vertical { position: relative; width: 160px; height: 320px; background: #0a0a12; border: 3px solid #533483; border-radius: 12px; overflow: hidden; box-shadow: inset 0 0 15px rgba(0,0,0,0.8); }
        .reel-vertical { display: flex; flex-direction: column; position: absolute; left: 0; top: 0; width: 100%; will-change: transform; }
        .item-vertical { width: 100%; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: none; background: linear-gradient(90deg, #16213e 0%, #0f3460 100%); }
        .pointer-vertical { position: absolute; top: 50%; left: 0; transform: translateY(-50%); width: 100%; height: 4px; background: #fff; z-index: 100; box-shadow: 0 0 10px #fff; }
        .skin-img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 5px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        .spinner-text-h { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; max-width: 110px; text-align: center; white-space: normal; color: #ddd; }
        .contents-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; width: 100%; margin-top: 20px; }
        .item-card { border-radius: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; text-align: center; transition: transform 0.2s; position: relative; overflow: hidden; background: rgba(255,255,255,0.02); }
        .item-card:hover { transform: translateY(-3px); }
        .item-card img { width: 90px; height: 60px; object-fit: contain; margin-bottom: 8px; }

/* --- NEW BATTLE STYLES (PackDraw Style) --- */
        .battle-info-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #121212; padding: 15px 25px; border-radius: 12px;
            margin-bottom: 20px; border: 1px solid #2f4553; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .bib-stat { font-weight: bold; font-size: 1.1rem; color: #b1bad3; }
        .bib-highlight { color: #fff; margin-left: 5px; }

        .battle-arena-container { 
            display: flex; gap: 15px; justify-content: center; align-items: flex-start; 
            flex-wrap: nowrap; overflow-x: auto; padding-bottom: 20px;
        }

        .battle-column {
            flex: 1; /* Allow shrinking/growing */
            min-width: 0; /* Allow shrinking smaller than content if needed */
            background: transparent; border: none; padding: 0;
            display: flex; flex-direction: column; gap: 10px;
            transition: all 0.3s ease;
        }
        
        /* Force smaller text/avatars if 6 players are present */
        .battle-arena-container.six-player-mode .buc-avatar { width: 35px; height: 35px; font-size: 1rem; }
        .battle-arena-container.six-player-mode .buc-name { font-size: 0.75rem; }

        /* User Header Card */
        .battle-user-card {
            background: #16213e; border-radius: 8px; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid #2f4553; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .buc-avatar {
            width: 40px; height: 40px; border-radius: 50%; background: #2f4553;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            margin-bottom: 5px; border: 2px solid #533483;
        }
        .buc-name { font-weight: bold; font-size: 0.9rem; color: #fff; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .buc-total {
            background: #213743; color: #00e701; font-family: monospace; font-weight: bold;
            padding: 4px 10px; border-radius: 4px; font-size: 0.9rem; width: 100%; text-align: center;
        }

        

        /* History List */
        .battle-history { display: flex; flex-direction: column; gap: 8px; width: 100%; }

        .history-item {
            display: flex; flex-direction: column; align-items: center;
            background: rgba(22, 33, 62, 0.6); border: 1px solid #2f4553;
            border-radius: 6px; padding: 10px; animation: slideDown 0.3s ease-out;
        }
        .history-item img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 5px; }
        .history-item-name { font-size: 0.75rem; color: #b1bad3; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .history-item-price { font-size: 0.8rem; font-weight: bold; color: #fff; }

        /* Winner highlighting */
        .winner-glow .battle-user-card { border-color: #00e701; box-shadow: 0 0 15px rgba(0, 231, 1, 0.2); }
        .loser-dim { opacity: 0.6; }

/* --- NEW JACKPOT STYLES --- */
        #jackpot-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        /* Hide the old text */
        #winner-announcement { display: none; }

        .jackpot-container {
            position: relative;
            width: 80%; max-width: 800px;
            padding: 20px;
            background: #16213e; border: 2px solid #533483; border-radius: 20px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            text-align: center;
        }
        
        /* Taller, rounder viewport */
        .viewport-horizontal {
            width: 600px; height: 70px; /* Taller */
            margin: 0 auto 20px auto;
            overflow: hidden; position: relative;
            border-radius: 35px; /* Pill shape */
            border: 3px solid #fff;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        .reel-horizontal { display: flex; height: 100%; }

        .jackpot-bar {
            height: 100%;
            /* Center content (avatar) inside the bar */
            display: flex; align-items: center; justify-content: center;
            position: relative;
            box-shadow: inset -2px 0 5px rgba(0,0,0,0.2); /* Slight separation definition */
        }
        
        /* Avatar inside the bar */
        .jackpot-bar-pfp {
            height: 80%; /* Fit within the 70px height */
            aspect-ratio: 1;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.8);
            font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.2);
        }

        .pointer-horizontal {
            position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 80px; background: #fff; z-index: 10;
            box-shadow: 0 0 10px #fff;
        }

        /* Improved Legend */
        .jackpot-legend { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 10px;}
        .legend-item { 
            display: flex; align-items: center; gap: 10px; 
            background: rgba(0,0,0,0.4); padding: 8px 15px; border-radius: 30px; 
            border: 1px solid #2f4553;
        }
        .legend-pfp { font-size: 1.2rem; }
        .legend-dot { width: 14px; height: 14px; border-radius: 50%; box-shadow: 0 0 5px currentColor;}
        .legend-name { color: #fff; font-weight: bold; font-size: 0.9rem; }

        /* Final Winner Overlay Card */
        .jackpot-winner-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
            background: rgba(22, 33, 62, 0.95);
            border: 3px solid #00e701; border-radius: 20px;
            padding: 30px; display: flex; flex-direction: column; align-items: center;
            gap: 10px;
            opacity: 0; pointer-events: none; transition: all 0.5s ease-out;
            z-index: 20;
            box-shadow: 0 0 50px rgba(0, 231, 1, 0.3);
        }
        .jwo-visible { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
        .jwo-avatar { font-size: 4rem; margin-bottom: 10px; }
        .jwo-title { font-size: 1.2rem; color: #b1bad3; text-transform: uppercase; letter-spacing: 2px;}
        .jwo-name { font-size: 2.5rem; font-weight: 900; color: #fff; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .jwo-amount { font-size: 2rem; color: #00e701; font-family: monospace; font-weight: bold; }

        /* BLACKJACK UTILS */
        .bj-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: flex-start; }
        .bj-sidebar { flex: 1 1 250px; max-width: 300px; background: #213743; border-radius: 8px; padding: 20px; text-align: left; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .bj-table-area { flex: 2 1 350px; background-color: #0f212e; border-radius: 15px; padding: 30px 20px; position: relative; min-height: 450px; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; justify-content: space-between; align-items: center; }
        .bj-rules-text { font-size: 0.75rem; color: #5e7082; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
        .bj-hand-container { display: flex; gap: -20px; height: 110px; justify-content: center; perspective: 1000px; }
        .bj-card { width: 70px; height: 100px; border-radius: 6px; background: white; color: black; font-weight: bold; font-size: 1.2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: -2px 2px 5px rgba(0,0,0,0.4); position: relative; margin: 0 5px; }
        .card-deal-anim { animation: dealSlide 0.4s ease-out forwards; opacity: 0; }
        .bj-card.red { color: #d32f2f; } .bj-card.black { color: #000; }
        .bj-card.back { background: #1461bd; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.1) 5px, rgba(255,255,255,0.1) 10px); border: 2px solid #fff; }
        .bj-card .val-corner { position: absolute; top: 2px; left: 4px; font-size: 0.8rem; }
        .hand-score-bubble { background: #2f4553; color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.9rem; display: inline-block; margin-bottom: 5px; font-weight: bold; }
        .insurance-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 20px; border-radius: 10px; border: 2px solid #ff9800; z-index: 50; text-align: center; width: 80%; }

        /* HISTORY TABLE */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #213743; border-radius: 8px; overflow: hidden; }
        .history-table th { background: #162a36; padding: 10px; text-align: left; color: #b1bad3; font-size: 0.85rem; }
        .history-table td { padding: 10px; border-bottom: 1px solid #2f4553; font-size: 0.85rem; }
        .win-text { color: #00e701; font-weight: bold; }
        .lose-text { color: #ff4d4d; font-weight: bold; }

        /* FOOTER */
        .footer { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(15, 33, 46, 0.95); 
            border-top: 1px solid #2f4553; padding: 15px; text-align: center; color: #5e7082; font-size: 0.8rem;
            z-index: 900; backdrop-filter: blur(5px);
        }
        .footer a { color: #b1bad3; text-decoration: none; font-weight: bold; transition: color 0.2s; cursor: pointer; }
        .footer a:hover { color: #fff; }
        
        /* GUIDE TAB */
        .guide-tabs { display: flex; border-bottom: 1px solid #2f4553; margin-bottom: 15px; flex-wrap: wrap; }
        .guide-tab { padding: 10px 20px; cursor: pointer; color: #b1bad3; font-weight: bold; border-bottom: 3px solid transparent; flex: 1; text-align: center; }
        .guide-tab.active { color: #00e701; border-bottom-color: #00e701; }
        .guide-section { display: none; }
        .guide-section.active { display: block; animation: slideDown 0.2s ease; }
        .code-block { background: #000; color: #0f0; padding: 10px; border-radius: 5px; overflow-x: auto; font-family: monospace; font-size: 0.8rem; margin: 10px 0; border: 1px solid #2f4553; }
        .guide-p { color: #b1bad3; font-size: 0.9rem; line-height: 1.5; margin-bottom: 10px; }

        @keyframes popIn { 0% { opacity: 0; transform: translateY(20px) scale(0.95); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes slideDown { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes dealSlide { 0% { opacity: 0; transform: translateY(-50px) translateX(20px) rotate(10deg); } 100% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg); } }

/* --- BATTLE RESULTS SCREEN (New) --- */
.battle-results-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(15, 33, 46, 0.98); 
    backdrop-filter: blur(10px);
    z-index: 500;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
}
.bro-visible { opacity: 1; pointer-events: auto; }

.bro-header { font-size: 2rem; font-weight: 900; color: #fff; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 2px; }

.bro-winners-row { display: flex; gap: 40px; margin-bottom: 50px; justify-content: center; }

.bro-winner-card {
    display: flex; flex-direction: column; align-items: center;
    position: relative; animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.bro-crown {
    font-size: 3rem; position: absolute; top: -35px; left: 50%; transform: translateX(-50%) rotate(-10deg);
    filter: drop-shadow(0 0 10px gold); z-index: 2;
}

.bro-avatar {
    width: 100px; height: 100px; border-radius: 50%; 
    background: #16213e; border: 4px solid #ffd700;
    display: flex; align-items: center; justify-content: center; font-size: 3.5rem;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); margin-bottom: 15px;
}

.bro-name { font-size: 1.2rem; font-weight: bold; color: #fff; margin-bottom: 5px; }
.bro-amount { font-size: 1.1rem; color: #ffd700; font-family: monospace; font-weight: bold; }

.bro-actions { display: flex; gap: 20px; }
.bro-btn {
    padding: 15px 30px; border-radius: 8px; font-weight: bold; font-size: 1rem; border: none; cursor: pointer;
    transition: transform 0.2s; text-transform: uppercase;
}
.bro-btn:hover { transform: translateY(-3px); }
.bro-replay { background: #00e701; color: #0f212e; box-shadow: 0 5px 15px rgba(0, 231, 1, 0.3); }
.bro-new { background: #2f4553; color: #fff; }

/* FIX FOR THE WHITE LINE */
.pointer-hidden .pointer-horizontal { opacity: 0 !important; }
      
/* --- NEW BATTLE CREATION (ISOLATED STYLES) --- */
    .nc-dashboard {
        width: 100%; max-width: 1000px; margin: 0 auto;
        color: #fff; font-family: 'Segoe UI', sans-serif; text-align: left;
    }
    
    .nc-section { margin-bottom: 35px; }
    .nc-section-center { text-align: center; margin-bottom: 30px; }
    
    .nc-label {
        display: block; font-size: 0.85rem; color: #6e7a8e; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 15px;
    }
    .nc-center-text { text-align: center; }

    /* PILLS (1v1, 2v2) */
    .nc-pill-container {
        display: inline-flex; background: #161920; padding: 4px; border-radius: 50px;
        border: 1px solid #2f3540;
    }
    .nc-pill {
        background: transparent; border: none; color: #8a9bb0; padding: 10px 30px;
        border-radius: 40px; font-weight: 700; cursor: pointer; transition: all 0.2s;
        font-size: 0.9rem;
    }
    .nc-pill:hover { color: #fff; }
    .nc-pill.active { background: #3b82f6; color: #fff; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }

    /* MODE CARDS (Classic, Jackpot) */
    .nc-mode-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;
    }
    .nc-mode-card {
        background: #161920; border: 2px solid #23262f; border-radius: 16px;
        height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
    }
    .nc-mode-card:hover { border-color: #3b82f6; transform: translateY(-2px); }
    .nc-mode-card.active {
        border-color: #3b82f6; background: rgba(59, 130, 246, 0.08);
        box-shadow: inset 0 0 20px rgba(59, 130, 246, 0.1);
    }
    .nc-mode-card.disabled { opacity: 0.4; cursor: not-allowed; border-color: transparent; }
    
    .nc-icon { font-size: 2.5rem; margin-bottom: 15px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
    .nc-mode-title { font-weight: 700; font-size: 1rem; }
    .nc-desc { margin-top: 15px; color: #6e7a8e; font-size: 0.9rem; max-width: 600px; line-height: 1.5; }

    /* SELECTED BOXES AREA */
    .nc-cart-grid {
        display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px 20px 5px;
        min-height: 200px; align-items: center;
    }
    
    /* ADD BUTTON */
    .nc-add-card {
        flex: 0 0 130px; height: 180px; border: 2px dashed #2f3540; border-radius: 12px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: #6e7a8e; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.02);
    }
    .nc-add-card:hover { border-color: #3b82f6; color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
    .nc-plus { font-size: 2.5rem; margin-bottom: 10px; font-weight: 300; }
    .nc-add-text { font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }

    /* CART ITEM */
    .nc-item-card {
        flex: 0 0 130px; height: 180px; background: #1b1e26; border-radius: 12px;
        position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
        border: 1px solid #2f3540; box-shadow: 0 10px 20px rgba(0,0,0,0.2); transition: 0.2s;
    }
    .nc-item-card:hover { transform: translateY(-5px); border-color: #4cd964; }
    .nc-item-img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 15px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
    .nc-item-price { color: #4cd964; font-weight: 700; font-family: monospace; font-size: 0.95rem; }
    .nc-badge {
        position: absolute; top: 10px; right: 10px; background: #3b82f6; color: #fff;
        font-size: 0.75rem; font-weight: 800; padding: 3px 8px; border-radius: 6px;
    }
    .nc-remove {
        position: absolute; top: 8px; left: 8px; color: #ef4444; cursor: pointer;
        font-size: 1.2rem; opacity: 0; transition: 0.2s; padding: 5px;
    }
    .nc-item-card:hover .nc-remove { opacity: 1; }

    /* SUMMARY FOOTER */
    .nc-summary {
        background: #161920; border: 1px solid #23262f; border-radius: 16px;
        padding: 30px; margin-top: 20px;
    }
    .nc-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #23262f; color: #b1bad3; font-weight: 600; font-size: 0.9rem; }
    .nc-row span:last-child { color: #fff; }
    .nc-row:last-of-type { border-bottom: none; margin-bottom: 15px; }
    
    .nc-create-btn {
        width: 100%; background: #4cd964; color: #052e16; font-weight: 800; font-size: 1.1rem;
        padding: 18px; border: none; border-radius: 10px; cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s; text-transform: uppercase; letter-spacing: 1px;
    }
    .nc-create-btn:hover { background: #5ce073; box-shadow: 0 0 20px rgba(76, 217, 100, 0.4); transform: translateY(-2px); }
    
    .nc-clear-btn {
        background: transparent; border: none; color: #6e7a8e; font-weight: 600; font-size: 0.85rem;
        margin-top: 15px; cursor: pointer; width: 100%; transition: 0.2s;
    }
    .nc-clear-btn:hover { color: #ef4444; }     
/* --- FIX: SEPARATE CASE OPENER & JACKPOT STYLES --- */
    
    /* 1. Force Case Opener to be a large RECTANGLE */
    #case-opener .viewport-horizontal {
        height: 160px !important;       /* Taller */
        border-radius: 12px !important; /* Rectangle corners */
        border: 3px solid #533483 !important;
        background: #0a0a12 !important;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.8) !important;
        width: 100% !important;
        max-width: 800px !important;
    }
    #case-opener .pointer-horizontal {
        height: 100% !important; /* Full height pointer */
        top: 0 !important;
        border: none !important;
        width: 4px !important;
        background: #fff !important;
    }

    /* 2. Force Jackpot to be a small PILL */
    #jackpot-window .viewport-horizontal {
        height: 100px !important;       /* Shorter */
        border-radius: 50px !important; /* Pill shape */
        border: 4px solid #ffd700 !important;
        background: #0f1923 !important;
    } 
/* --- HIGH VISIBILITY FLOATING REELS --- */
    
    .battle-reel-wrapper {
        height: 320px !important; 
        background: transparent !important; 
        border: none !important; 
        position: relative;
        /* Softer mask so items are visible longer */
        mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
        -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
        border-left: 1px solid rgba(255,255,255,0.05) !important;
        border-right: 1px solid rgba(255,255,255,0.05) !important;
    }

    /* Brighter Center Spotlight */
    .center-highlight {
        position: absolute; top: 50%; left: 0; width: 100%; height: 110px;
        transform: translateY(-50%);
        /* Bright radial glow */
        background: radial-gradient(ellipse at center, rgba(255, 255, 255, 0.12) 0%, transparent 70%);
        border-top: 1px solid rgba(255,255,255,0.15);
        border-bottom: 1px solid rgba(255,255,255,0.15);
        pointer-events: none; z-index: 5;
    }

    /* Spinning Items (Now Colorful & Bright) */
    .item-vertical {
        height: 110px !important; 
        width: 100%;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: transparent !important; 
        border: none !important; 
        box-shadow: none !important;
        
        /* FIX: Increased opacity (was 0.35) */
        opacity: 0.75; 
        transform: scale(0.9);
        transition: opacity 0.3s, transform 0.3s;
    }

    .item-vertical img {
        /* FIX: Removed grayscale so they aren't dead/dark */
        filter: brightness(0.95); 
        transition: all 0.3s ease;
        max-height: 80px; width: auto;
    }

    /* Winner State (Super Glow) */
    .item-vertical.winner-landed {
        opacity: 1 !important; 
        transform: scale(1.25) !important;
        z-index: 10;
    }
    
    .item-vertical.winner-landed img {
        /* Maximum brightness + drop shadow */
        filter: brightness(1.3) drop-shadow(0 0 25px rgba(255, 255, 255, 0.5));
    }

    /* Text Reveal */
    .spinner-text-v { 
        opacity: 0; 
        transform: translateY(10px);
        transition: all 0.3s ease;
        pointer-events: none;
    }
    .item-vertical.winner-landed .spinner-text-v { 
        opacity: 1; 
        transform: translateY(0);
    }

    .payline-indicator {
        position: absolute; top: 50%; width: 0; height: 0;
        transform: translateY(-50%);
        border-top: 6px solid transparent;
        border-bottom: 6px solid transparent;
        z-index: 20; opacity: 0.8;
    }
 /* --- TOGGLE SWITCH --- */
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #2f3540; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #e94560; } /* Crazy Red */
    input:checked + .slider:before { transform: translateX(24px); }
/* --- SLEEK DARK PRICE PILLS --- */

    /* 1. Container Positioning */
    .spinner-text-v {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 20;
        position: relative;
        margin-top: 6px;
    }

    /* 2. Item Name (Clean Shadow) */
    .spinner-text-v div:first-child {
        font-size: 0.8rem !important;
        font-weight: 700 !important;
        color: #fff !important;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8); /* Softer shadow */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 95%;
        margin-bottom: 4px;
        opacity: 0.9;
    }

    /* 3. Item Price - THE DARK PILL */
    .spinner-text-v div:last-child {
        font-size: 0.95rem !important; /* Slightly smaller for balance */
        font-weight: 800 !important;
        font-family: 'Segoe UI', monospace !important;
        letter-spacing: 0.5px;
        
        /* Dark Background (Instead of White) */
        background: rgba(0, 0, 0, 0.7) !important; 
        
        /* Subtle Border */
        border: 1px solid rgba(255,255,255,0.15) !important;
        
        padding: 2px 12px !important;
        border-radius: 12px !important; /* More rounded */
        
        /* Color matches Rarity */
        color: var(--r-color, #fff) !important; 
        text-shadow: 0 0 5px rgba(0,0,0,0.5);
        
        transition: all 0.3s ease;
    }

    /* 4. Winner State - NEON GLOW (Not White Background) */
    .item-vertical.winner-landed .spinner-text-v div:last-child {
        background: #000 !important; /* Pure Black background */
        color: var(--r-color) !important; /* Colored Text */
        border: 1px solid var(--r-color) !important; /* Colored Border */
        
        /* Colored Glow */
        box-shadow: 0 0 10px var(--r-color), inset 0 0 10px rgba(0,0,0,0.5) !important;
        
        transform: scale(1.1);
    }
    
    /* 5. Winner Name brightness */
    .item-vertical.winner-landed .spinner-text-v div:first-child {
        color: #fff !important;
        opacity: 1 !important;
        text-shadow: 0 0 5px var(--r-color);
    }

/* --- PRO CASE CONTENT CARDS --- */
    .item-card {
        background: linear-gradient(180deg, #12141c 0%, #1b1e28 100%) !important;
        border: 1px solid rgba(255,255,255,0.05) !important;
        border-radius: 12px !important;
        padding: 15px !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: space-between !important;
        position: relative !important;
        overflow: hidden !important;
        transition: transform 0.2s, box-shadow 0.2s !important;
        min-height: 170px; /* Fixed height for consistency */
    }

    .item-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        border-color: rgba(255,255,255,0.1) !important;
    }

    /* Rarity Glow Bar at Bottom */
    .item-card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--r-color); /* Uses the rarity color */
        box-shadow: 0 -2px 15px var(--r-color);
    }

    /* Image Styling */
    .item-card img {
        width: 100%;
        height: 90px;
        object-fit: contain;
        margin-bottom: 15px;
        filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
        transition: transform 0.3s ease;
        z-index: 1;
    }

    .item-card:hover img {
        transform: scale(1.1) rotate(2deg);
    }

    /* Item Name */
    .item-name {
        font-family: 'Inter', sans-serif;
        font-size: 0.85rem;
        font-weight: 600;
        color: #b1bad3;
        text-align: center;
        margin-bottom: 10px;
        line-height: 1.3;
        z-index: 2;
    }

    /* Price & Chance Footer */
    .item-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        background: rgba(0,0,0,0.4);
        padding: 8px 12px;
        border-radius: 8px;
        margin-top: auto; /* Pushes to bottom */
        border: 1px solid rgba(255,255,255,0.05);
        z-index: 2;
    }

    .item-price {
        color: #fff;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .item-chance {
        color: var(--r-color); /* Color the % based on rarity */
        font-weight: 800;
        font-size: 0.85rem;
    }

/* --- CASE OPENER OVERHAUL --- */

    /* 1. Pro Horizontal Item Card */
    .item-horizontal {
        min-width: 140px; /* Slightly wider */
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        
        /* Dark Gradient Background */
        background: linear-gradient(180deg, #161920 0%, #0f1216 100%) !important;
        border-right: 1px solid rgba(255,255,255,0.05) !important;
        border-bottom: 4px solid var(--r-color) !important; /* Rarity Bar */
        
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }

    /* 2. Horizontal Image Sizing */
    .item-horizontal img {
        width: 90px;
        height: 70px;
        object-fit: contain;
        margin-bottom: 8px;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
        z-index: 10;
    }

    /* 3. Horizontal Price Pill (Matches Battle Mode) */
    .item-horizontal .spinner-text-h {
        font-family: 'Inter', sans-serif;
        font-size: 0.9rem !important;
        font-weight: 800 !important;
        color: #fff !important;
        
        background: rgba(0,0,0,0.6) !important;
        border: 1px solid rgba(255,255,255,0.1);
        padding: 4px 10px;
        border-radius: 4px;
        z-index: 20;
    }

    /* 4. Motion Blur Class (Applied via JS) */
    .blur-effect {
        filter: blur(4px); /* Horizontal motion blur */
        transition: filter 0.5s ease;
    }
    
    /* 5. Pointer Update */
    .pointer-horizontal {
        z-index: 100;
        background: #e94560 !important; /* Red pointer for visibility */
        width: 3px !important;
        box-shadow: 0 0 15px #e94560 !important;
    }
    
    /* 6. Winner Landed Effect */
    .item-horizontal.winner-landed {
        background: #252a35 !important;
        box-shadow: inset 0 0 30px var(--r-color) !important;
        z-index: 50;
    }
    .item-horizontal.winner-landed img {
        transform: scale(1.15);
        filter: drop-shadow(0 0 15px var(--r-color));
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

/* --- NEW AUTO DICE MENU --- */
    .strategy-row {
        background: #162a36; 
        padding: 8px 12px; 
        border-radius: 8px; 
        margin-bottom: 8px;
        display: flex; 
        align-items: center; 
        justify-content: space-between;
        border: 1px solid #2f4553;
    }
    
    .strat-label { 
        font-weight: 800; 
        font-size: 0.75rem; 
        text-transform: uppercase; 
        min-width: 60px;
    }
    
    .strat-controls { 
        display: flex; 
        gap: 5px; 
        align-items: center; 
    }
    
    .strat-btn {
        background: transparent; 
        border: 1px solid #2f4553; 
        color: #b1bad3;
        padding: 6px 10px; 
        border-radius: 6px; 
        cursor: pointer; 
        font-size: 0.7rem; 
        font-weight: bold;
        transition: all 0.2s;
    }
    
    .strat-btn:hover { background: rgba(255,255,255,0.05); }
    
    .strat-btn.active { 
        background: #2f4553; 
        color: #fff; 
        border-color: #533483; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .strat-input {
        width: 70px !important; 
        padding: 5px !important; 
        font-size: 0.85rem !important;
        background: rgba(0,0,0,0.3) !important; 
        border: 1px solid #2f4553 !important;
        text-align: center;
        height: 28px;
    }

/* --- LIVE STATS POPUP --- */
/* --- NEW NAV STATS BUTTON --- */
    .nav-stats-btn {
        background: rgba(0, 231, 1, 0.1); 
        border: 1px solid #00e701; 
        color: #00e701; 
        font-size: 0.9rem; 
        cursor: pointer;
        padding: 8px 15px; 
        border-radius: 8px; 
        transition: all 0.2s; 
        display: flex; 
        align-items: center; 
        gap: 8px;
        font-weight: bold;
        height: 40px;
        margin-left: 15px; /* Spacing from Menu */
    }
    .nav-stats-btn:hover { 
        background: #00e701; 
        color: #000; 
        box-shadow: 0 0 15px rgba(0,231,1,0.4); 
    }
    
    /* Updated Grid to hold 5 items cleanly */
    .ls-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 15px; 
        margin-bottom: 15px; 
    }

    .live-stats-popup {
        position: fixed; top: 100px; right: 20px; width: 280px;
        background: #1a2c38; border-radius: 12px; border: 1px solid #2f4553;
        box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 5000;
        display: flex; flex-direction: column; overflow: hidden;
        font-family: 'Segoe UI', sans-serif;
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .ls-header {
        background: #0f212e; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;
        cursor: grab; border-bottom: 1px solid #2f4553; user-select: none;
    }
    .ls-header:active { cursor: grabbing; }
    .ls-title { font-weight: 800; color: #fff; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
    
    .ls-controls { display: flex; gap: 10px; }
    .ls-btn { background: transparent; border: none; color: #b1bad3; cursor: pointer; font-size: 1rem; transition: color 0.2s; padding: 0; }
    .ls-btn:hover { color: #fff; }

    .ls-content { padding: 15px; }
    
    .ls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .ls-stat { display: flex; flex-direction: column; }
    .ls-label { font-size: 0.7rem; color: #b1bad3; font-weight: 700; margin-bottom: 4px; }
    .ls-value { font-size: 0.95rem; color: #fff; font-weight: 700; font-family: monospace; }
    .ls-green { color: #00e701; }
    .ls-red { color: #ff4d4d; }

    .ls-chart-container {
        height: 100px; width: 100%; 
        background: linear-gradient(180deg, rgba(0, 231, 1, 0.05) 0%, transparent 100%);
        border-radius: 8px; border: 1px solid rgba(0, 231, 1, 0.1);
        overflow: hidden; position: relative;
    }
    
    .ls-footer {
        padding: 12px 15px; background: #16213e; border-top: 1px solid #2f4553;
        font-size: 0.75rem; color: #8a9bb0; font-weight: bold; display: flex; justify-content: space-between;
    }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:15px;">
            <div class="nav-container">
                <button class="menu-btn" onclick="AudioEngine.ui()">Menu <span></span></button>
                <div class="dropdown-content">
                    <a onclick="switchScreen('home')"> Home</a>
                    <a onclick="switchScreen('battle')"> Box Battles</a>
                    <a onclick="switchScreen('cases')"> Cases</a>
                    <a onclick="switchScreen('blackjack')"> Blackjack</a>
                    <a onclick="switchScreen('game')"> Dice</a>
                    <a onclick="switchScreen('stats')"> Stats</a>
                    <a onclick="openHistory()"> History</a>
                </div>
            </div>
           <button class="nav-stats-btn" onclick="LiveStats.toggle()">
                 Live Stats
            </button>

            <h2 style="margin:0; margin-left: 20px; font-size:1.1rem; color: #fff; letter-spacing:1px; display:none; @media(min-width:800px){display:block;}">PRO ARCADE</h2>
        </div>

        <div class="user-panel">
            <div id="auth-section">
                <button class="auth-btn" onclick="openLogin()">Login / Register</button>
            </div>
            <div id="user-section" class="hidden" style="display:flex; align-items:center; gap:10px;">
                <div class="balance-wrapper">
                    <span class="balance-text">$<span id="global-balance">20.00</span></span>
                    <button class="plus-btn" onclick="openFundsModal()">+</button>
                </div>
                <div class="nav-container">
                    <button class="menu-btn" style="padding: 5px 10px; font-size:0.9rem;"> <span id="display-username">User</span></button>
                    <div class="dropdown-content" style="right:0; left:auto; min-width:150px;">
                        <a onclick="UserSystem.logout()">Logout</a>
                        <a onclick="UserSystem.reset()" style="color:#ff4d4d;">Reset Data</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="home-screen" class="screen">
        <h1 style="font-size: 2rem; margin-bottom: 10px; text-shadow: 0 0 20px rgba(83, 52, 131, 0.8);">ARCADE LOBBY</h1>
        <div class="home-grid">
            <div class="game-card" onclick="switchScreen('battle')">
                <div style="font-size: 3rem;"></div>
                <h3>Box Battles</h3>
                <p>PvP & Jackpot Modes</p>
            </div>
            <div class="game-card" onclick="switchScreen('cases')">
                <div style="font-size: 3rem;"></div>
                <h3>Lucky Cases</h3>
                <p>Unbox Rare Items</p>
            </div>
            <div class="game-card" onclick="switchScreen('game')">
                <div style="font-size: 3rem;"></div>
                <h3>Dice</h3>
                <p>6x Multiplier</p>
            </div>
            <div class="game-card" onclick="switchScreen('blackjack')">
                <div style="font-size: 3rem;"></div>
                <h3>Blackjack</h3>
                <p>Classic 21</p>
            </div>
        </div>
    </div>

<div id="battle-screen" class="screen hidden">
        
        <div id="battle-setup">
            <div class="nc-dashboard">
                
                <div class="nc-section nc-section-center">
                    <label class="nc-label nc-center-text">Battle Configuration</label>
										<div class="nc-pill-container">
                        <button class="nc-pill active" onclick="setBattleMode('1v1', this)">1v1</button>
                        <button class="nc-pill" onclick="setBattleMode('1v1v1', this)">1v1v1</button>
                        <button class="nc-pill" onclick="setBattleMode('1v1v1v1', this)">1v1v1v1</button>
                        <button class="nc-pill" onclick="setBattleMode('2v2', this)">2v2</button>
                        <button class="nc-pill" onclick="setBattleMode('3v3', this)">3v3</button>
                        <button class="nc-pill" onclick="setBattleMode('2v2v2', this)">2v2v2</button>
                    </div>
                </div>

                <div class="nc-section">
                    <label class="nc-label">Game Mode</label>
                    <div class="nc-mode-grid">
                        <div class="nc-mode-card active" id="card-std" onclick="setBattleType('standard')">
                            <div class="nc-icon"></div>
                            <div class="nc-mode-title">Classic</div>
                        </div>
                        <div class="nc-mode-card" id="card-jack" onclick="setBattleType('jackpot')">
                            <div class="nc-icon"></div>
                            <div class="nc-mode-title">Jackpot</div>
                        </div>
                        <div class="nc-mode-card" id="card-point" onclick="setBattleType('point')">
                            <div class="nc-icon"></div>
                            <div class="nc-mode-title">Point Rush</div>
                        </div>
                        <div class="nc-mode-card disabled">
                            <div class="nc-icon"></div>
                            <div class="nc-mode-title">Elimination</div>
                        </div>
                    </div>
                    <div class="nc-desc" id="mode-desc">In Classic mode, the player with the highest total value at the end wins the entire battle.</div>

<div class="nc-section" style="margin-top:25px; background:#161920; padding:15px; border-radius:12px; border:1px solid #2f3540; display:flex; align-items:center; justify-content:space-between;">
    <div style="display:flex; align-items:center; gap:15px;">
        <div style="font-size:1.8rem;"></div>
        <div>
            <div style="font-weight:bold; font-size:1rem; color:#fff;">Crazy Mode</div>
            <div style="font-size:0.8rem; color:#8a9bb0;">Lowest value wins. Reverse odds for Jackpot.</div>
        </div>
    </div>
    <label class="switch">
        <input type="checkbox" id="crazy-toggle" onchange="toggleCrazyMode()">
        <span class="slider round"></span>
    </label>
</div>
</div> 

<div class="nc-section">
    <label class="nc-label">Selected Boxes (<span id="nc-pack-count">0</span>)</label>
                </div>

                <div class="nc-section">
                    <label class="nc-label">Selected Boxes (<span id="nc-pack-count">0</span>)</label>
                    <div class="nc-cart-grid" id="battle-cart-grid">
                        <div class="nc-add-card" onclick="openCaseModal()">
                            <div class="nc-plus">+</div>
                            <div class="nc-add-text">Add Box</div>
                        </div>
                    </div>
                </div>

                <div class="nc-summary">
                    <label class="nc-label" style="border-bottom: 1px solid #2f3540; padding-bottom: 10px; margin-bottom: 20px;">Battle Summary</label>
                    <div class="nc-row">
                        <span>Players</span>
                        <span id="nc-players">2</span>
                    </div>
                    <div class="nc-row">
                        <span>Rounds</span>
                        <span id="nc-rounds">0</span>
                    </div>
                    <div class="nc-row">
                        <span>Total Cost</span>
                        <span id="nc-cost">$0.00</span>
                    </div>
                    <button class="nc-create-btn" onclick="startBattle()">Create Battle for <span id="nc-btn-cost">$0.00</span></button>
                    <button class="nc-clear-btn" onclick="clearBattleQueue()">Clear Selection</button>
                </div>

            </div>
        </div>

        <div id="battle-arena" class="hidden" style="position: relative; min-height: 500px;">
            <div id="battle-arena-container" class="battle-arena-container"></div>
            <div id="battle-result-text" style="font-size: 1.5rem; font-weight: bold; margin: 20px 0; text-align:center;"></div>
            <div style="text-align:center;">
                <button class="btn btn-secondary hidden" id="btn-battle-reset" onclick="resetBattleUI()">NEW BATTLE</button>
            </div>
        </div>

    </div>
 
    <div id="jackpot-wrapper" class="hidden">
        <div id="jackpot-window" class="jackpot-container">
            <h3 style="color:#ffd600; font-size: 1.8rem; margin-bottom: 20px; text-transform:uppercase; letter-spacing:2px;">Jackpot Spin</h3>
            <div class="viewport-horizontal" style="margin: 0 auto; border-color: #ffd600; width: 100%; height: 100px;">
                <div class="pointer-horizontal" style="background:#fff; height:100%; width: 4px; box-shadow: 0 0 10px #fff; z-index:200;"></div>
                <div id="jackpot-reel" class="reel-horizontal"></div>
            </div>
            <div id="winner-announcement" style="margin-top: 20px; font-size: 1.5rem; font-weight: bold;"></div>
        </div>
    </div>

<div id="game-screen" class="screen hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0;">Dice</h2>
            <button class="btn btn-ghost" style="width:auto; padding:8px 15px; font-size:0.9rem;" onclick="ProvablyFair.openModal()"> Fairness</button>
        </div>
        
        <div class="dice-layout">
            
            <div class="dice-sidebar">
                <div class="multi-control" style="width:100%; margin-bottom:15px;">
                    <button class="multi-btn active" id="btn-dice-manual" onclick="setDiceMode('manual')" style="flex:1;">Manual</button>
                    <button class="multi-btn" id="btn-dice-auto" onclick="setDiceMode('auto')" style="flex:1;">Auto</button>
                </div>

                <div class="input-group" style="margin-bottom:5px; padding:10px; border-radius:8px;">
                    <label>Bet Amount</label>
                    <div style="display:flex;">
                        <span style="color:#aaa; margin-right:5px;">$</span>
                        <input type="number" id="dice-wager" value="10.00" style="background:transparent; border:none; padding:0; width:80%;" oninput="updateDiceCalculations()">
                    </div>
                </div>

                <div id="dice-manual-panel">
                    <div style="display:flex; gap:5px; margin-bottom:15px;">
                        <button class="btn btn-secondary" style="padding:8px;" onclick="adjustDiceBet(0.5); AudioEngine.ui()">1/2</button>
                        <button class="btn btn-secondary" style="padding:8px;" onclick="adjustDiceBet(2); AudioEngine.ui()">2x</button>
                    </div>
                </div>

                <div id="dice-auto-panel" class="hidden">
                    <div class="input-group" style="padding:10px; border-radius:8px; margin-bottom:10px; background:#162a36;">
                        <label style="margin:0 0 5px 0;">Number of Bets (0 = )</label>
                        <input type="number" id="auto-count" placeholder="0" style="background:rgba(0,0,0,0.2); border:1px solid #2f4553; font-family:'Inter',monospace;">
                    </div>
                    
                    <div class="strategy-row">
                        <div class="strat-label" style="color:#00e701;">On Win</div>
                        <div class="strat-controls">
                            <button class="strat-btn active" onclick="setAutoAction('win', 'reset', this)">Reset</button>
                            <button class="strat-btn" onclick="setAutoAction('win', 'increase', this)">Increase</button>
                            <input type="number" id="auto-win-inc" class="strat-input hidden" placeholder="%">
                        </div>
                    </div>

                    <div class="strategy-row">
                        <div class="strat-label" style="color:#ff4d4d;">On Loss</div>
                        <div class="strat-controls">
                            <button class="strat-btn active" onclick="setAutoAction('loss', 'reset', this)">Reset</button>
                            <button class="strat-btn" onclick="setAutoAction('loss', 'increase', this)">Increase</button>
                            <input type="number" id="auto-loss-inc" class="strat-input hidden" value="100" placeholder="%">
                        </div>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom:0; padding:10px; border-radius:8px; background:#162a36;">
                    <label>Profit on Win</label>
                    <div style="display:flex;">
                        <span style="color:#aaa; margin-right:5px;">$</span>
                        <input type="text" id="dice-profit-display" value="0.00" disabled style="background:transparent; border:none; padding:0; width:80%;">
                    </div>
                </div>

                <button class="btn btn-primary" id="dice-roll-btn" onclick="handleDiceAction()" style="margin-top:auto; font-size:1.2rem; padding:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">BET (ROLL)</button>
            </div>

            <div class="dice-main">
                <div class="dice-track-container">
                    <div class="dice-labels"><span>0</span><span>25</span><span>50</span><span>75</span><span>100</span></div>
                    <div class="dice-win-bar" id="dice-win-bar"></div>
                    <div class="dice-result-marker" id="dice-result-marker" style="left:50%; opacity:0;">50.00</div>
                    <input type="range" min="2" max="98" step="0.01" value="50" class="dice-slider" id="dice-slider" oninput="updateDiceFromSlider()">
                </div>
                <div class="dice-stat-row">
                    <div class="dice-stat-box">
                        <span class="dice-stat-label">Multiplier</span>
                        <input type="number" class="dice-stat-input" id="dice-mult" value="2.00" onchange="updateDiceFromMult()">
                    </div>
                    <div class="dice-stat-box">
                        <span class="dice-stat-label">Roll Over</span>
                        <input type="number" class="dice-stat-input" id="dice-target" value="50.00" onchange="updateDiceFromTarget()">
                    </div>
                    <div class="dice-stat-box">
                        <span class="dice-stat-label">Win Chance</span>
                        <div style="display:flex; align-items:center;">
                            <input type="number" class="dice-stat-input" id="dice-chance" value="49.50" onchange="updateDiceFromChance()">
                            <span style="color:#8a9bb0; font-weight:bold;">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="cases-screen" class="screen hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0;">Lucky Cases</h2>
            <button class="btn btn-ghost" style="width:auto; padding:8px 15px; font-size:0.9rem;" onclick="ProvablyFair.openModal()"> Fairness</button>
        </div>
        <div id="cases-list" class="case-grid"></div>
        <div id="case-opener" class="hidden">
            <div class="input-group" style="padding-bottom:5px; background:transparent; border:none; text-align:center; width:100%;">
                <h3 id="case-title" style="margin:0; text-align:center; font-size:1.5rem;">Case</h3>
                <div id="spinner-area"></div>
            </div>
            <div class="input-group" style="text-align:center; background:#16213e; border: 2px solid #533483; max-width: 500px; margin: 0 auto;">
                <div class="multi-control">
                    <button class="multi-btn active" id="btn-count-1" onclick="setOpenCount(1)">1x</button>
                    <button class="multi-btn" id="btn-count-2" onclick="setOpenCount(2)">2x</button>
                    <button class="multi-btn" id="btn-count-3" onclick="setOpenCount(3)">3x</button>
                    <button class="multi-btn" id="btn-count-4" onclick="setOpenCount(4)">4x</button>
                </div>
                <div style="margin-bottom: 15px; font-size:1.1rem; font-weight: bold; color: #e94560;" id="case-cost">Cost: 5</div>
                <div id="case-result-text" style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; min-height: 1.6em; white-space: pre-wrap;"></div>
                <button class="btn btn-primary" id="btn-open-case" onclick="triggerOpenCase()">OPEN CASE</button>
                <button class="btn btn-secondary" style="margin-top: 10px;" onclick="resetCaseMenu()">BACK TO LIST</button>
            </div>
            <div style="text-align:left; color:#aaa; font-weight:bold; margin-top:10px; width:100%; max-width:800px; margin: 20px auto 0 auto;">Case Contents:</div>
            <div id="case-contents-display" class="contents-grid" style="max-width:800px; margin: 0 auto;"></div>
        </div>
    </div>

    <div id="blackjack-screen" class="screen hidden">
         <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0;">Blackjack</h2>
            <button class="btn btn-ghost" style="width:auto; padding:8px 15px; font-size:0.9rem;" onclick="ProvablyFair.openModal()"> Fairness</button>
        </div>
        <div class="bj-container">
            <div class="bj-sidebar">
                <div class="input-group" style="background: transparent; border: none; padding: 0;">
                    <label>Bet Amount</label>
                    <div style="display:flex; border: 2px solid #2f4553; border-radius:4px; overflow:hidden;">
                        <input type="number" id="bj-wager" value="10.00" style="border:none;">
                        <span style="background:#0f212e; color:#b1bad3; padding:10px; font-weight:bold;">$</span>
                    </div>
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <button class="btn btn-secondary" style="padding:8px; font-size:0.8rem;" onclick="adjustBjBet(0.5); AudioEngine.ui()">1/2</button>
                        <button class="btn btn-secondary" style="padding:8px; font-size:0.8rem;" onclick="adjustBjBet(2); AudioEngine.ui()">2x</button>
                    </div>
                </div>
                <button class="btn btn-primary" id="btn-bj-deal" onclick="startBlackjack()" style="height:50px; font-size:1.1rem;">Bet</button>
                <div id="bj-controls" class="hidden" style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" id="btn-hit" onclick="bjHit()">Hit</button>
                        <button class="btn btn-secondary" id="btn-stand" onclick="bjStand()">Stand</button>
                    </div>
                    <button class="btn btn-secondary" id="btn-double" onclick="bjDouble()">Double x2</button>
                </div>
            </div>
            <div class="bj-table-area">
                <div class="bj-rules-text">Blackjack Pays 3 to 2  Dealer Stands on Soft 17</div>
                <div style="width:100%; text-align:center;">
                    <div class="hand-score-bubble" id="dealer-bubble">Dealer <span id="dealer-score"></span></div>
                    <div id="dealer-hand" class="bj-hand-container"></div>
                </div>
                <div class="bj-rules-text" style="margin: auto 0;">
                    <div id="bj-status-msg" style="color:#fff; font-size:1.5rem; text-shadow:0 2px 10px rgba(0,0,0,0.5);">Place your bet</div>
                </div>
                <div style="width:100%; text-align:center;">
                    <div id="player-hand" class="bj-hand-container"></div>
                    <div class="hand-score-bubble" id="player-bubble" style="margin-top:5px;">You <span id="player-score"></span></div>
                </div>
                <div id="bj-insurance-modal" class="insurance-modal hidden">
                    <h3>Insurance?</h3>
                    <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">Cost: <span id="ins-cost"></span> (Pays 2:1)</p>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button class="btn btn-primary" style="padding:10px 20px; width:auto;" onclick="handleInsurance(true)">Yes</button>
                        <button class="btn btn-danger" style="padding:10px 20px; width:auto;" onclick="handleInsurance(false)">No</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="stats-screen" class="screen hidden">
        <h2>Profit / Loss Graph</h2>
        <div style="background: #16213e; padding: 10px; border-radius: 15px; border: 1px solid #533483; max-width:800px; margin:0 auto;">
            <canvas id="profitChart"></canvas>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay hidden" onclick="if(event.target.id==='history-modal') document.getElementById('history-modal').classList.add('hidden')">
        <div class="modal-content" style="max-width:800px; height:80vh;">
            <div class="modal-header">
                <h3 style="margin:0">Game History</h3>
                <button class="btn btn-secondary" style="width:auto; padding:5px 15px;" onclick="document.getElementById('history-modal').classList.add('hidden')">Close</button>
            </div>
            <div class="history-controls">
                <label style="color:#b1bad3; font-weight:bold; font-size:0.9rem;">Filter Game:</label>
                <select id="history-filter" onchange="renderHistory()">
                    <option value="All">All Games</option>
                    <option value="Dice">Dice</option>
                    <option value="Blackjack">Blackjack</option>
                    <option value="Box Battle">Box Battle</option>
                    <option value="Cases">Cases</option>
                </select>
            </div>
            <div style="overflow-x:auto; flex:1; overflow-y:auto;">
                <table class="history-table">
                    <thead><tr><th>Game</th><th>Result</th><th>Profit/Loss</th><th>Verify</th><th>Date</th></tr></thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="login-modal" class="modal-overlay hidden" onclick="if(event.target.id==='login-modal') document.getElementById('login-modal').classList.add('hidden')">
        <div class="modal-content" style="max-width:400px; text-align:center;">
            <h2 style="color:#00e701; margin-top:0;">Welcome</h2>
            <p style="color:#b1bad3; margin-bottom:20px;">Login or create a local account to play.</p>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="login-username" placeholder="Enter username...">
            </div>
            <button class="btn btn-primary" onclick="UserSystem.login()">Start Playing</button>
            <p style="color:#5e7082; font-size:0.8rem; margin-top:15px;">Your data is saved locally in this browser.</p>
        </div>
    </div>

    <div id="case-modal" class="modal-overlay hidden" onclick="if(event.target.id==='case-modal') document.getElementById('case-modal').classList.add('hidden')">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">Select Cases</h3>
                <button class="btn btn-secondary" style="width:auto; padding:5px 15px;" onclick="document.getElementById('case-modal').classList.add('hidden')">Done</button>
            </div>
            <div id="modal-case-list" class="case-grid"></div>
        </div>
    </div>

    <div id="inspect-modal" class="modal-overlay hidden" onclick="if(event.target.id==='inspect-modal') document.getElementById('inspect-modal').classList.add('hidden')">
        <div class="modal-content" style="max-width:500px;">
            <h3>Case Contents</h3>
            <div id="inspect-content" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:10px;"></div>
            <button class="btn btn-secondary" style="margin-top:20px;" onclick="document.getElementById('inspect-modal').classList.add('hidden')">Close</button>
        </div>
    </div>

    <div id="funds-modal" class="modal-overlay hidden" onclick="if(event.target.id==='funds-modal') document.getElementById('funds-modal').classList.add('hidden')">
        <div class="modal-content" style="max-width:400px;">
            <h3>Deposit Funds</h3>
            <div class="input-group">
                <label>Amount ($)</label>
                <input type="number" id="deposit-amount" value="100">
            </div>
            <button class="btn btn-primary" onclick="submitFunds()">Add Funds</button>
        </div>
    </div>

    <div id="pf-modal" class="modal-overlay hidden" onclick="if(event.target.id==='pf-modal') document.getElementById('pf-modal').classList.add('hidden')">
        <div class="modal-content" style="max-width:600px; text-align:left;">
            <div class="modal-header">
                <h3 style="margin:0"> Provably Fair Settings</h3>
                <button class="btn btn-secondary" style="width:auto; padding:5px 15px;" onclick="document.getElementById('pf-modal').classList.add('hidden')">Close</button>
            </div>
            
            <div style="background:#213743; padding:15px; border-radius:10px; margin-bottom:20px;">
                <h4 style="margin:0 0 10px 0; color:#00e701;">Active Seed Pair</h4>
                <div class="pf-field">
                    <label>Client Seed</label>
                    <div class="pf-row">
                        <input type="text" id="pf-client-seed" value="dice-sim-client" style="flex:1;">
                        <button class="btn btn-primary" style="width:auto; padding:10px;" onclick="ProvablyFair.saveClientSeed()">Update</button>
                    </div>
                </div>
                <div class="pf-field">
                    <label>Server Seed (Hashed)</label>
                    <div class="pf-val-box" id="pf-server-hash" style="color:#aaa;">Loading...</div>
                </div>
                <div class="pf-field">
                    <label>Nonce (Next Roll)</label>
                    <div class="pf-val-box" id="pf-nonce">1</div>
                </div>
                <div style="text-align:right;">
                    <a onclick="showGuideFromModal(); document.getElementById('pf-modal').classList.add('hidden');" style="color:#00e701; text-decoration:underline; font-weight:bold; cursor:pointer; font-size:0.9rem;"> How does this work?</a>
                </div>
            </div>

            <div style="background:#16213e; padding:15px; border-radius:10px; border:1px solid #2f4553;">
                <h4 style="margin:0 0 10px 0; color:#b1bad3;">Rotate Seed</h4>
                <p style="font-size:0.85rem; color:#8a9bb0; margin-bottom:15px;">Rotating your seed will reveal the previous server seed, allowing you to verify all bets made with it.</p>
                <button class="btn btn-secondary" onclick="ProvablyFair.rotateSeed()"> Randomize & Verify Previous</button>
                
                <div id="pf-prev-data" class="hidden" style="margin-top:15px; border-top:1px solid #2f4553; padding-top:15px;">
                    <div class="pf-field">
                        <label>Previous Server Seed (Revealed)</label>
                        <div class="pf-val-box" id="pf-prev-seed" style="color:#e94560;">-</div>
                    </div>
                    <div class="pf-field">
                        <label>Previous Server Hash</label>
                        <div class="pf-val-box" id="pf-prev-hash">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="verify-modal" class="modal-overlay hidden" onclick="if(event.target.id==='verify-modal') document.getElementById('verify-modal').classList.add('hidden')">
        <div class="modal-content" style="max-width:600px; text-align:left;">
            <div class="modal-header">
                <h3 style="margin:0"> Verify Round</h3>
                <button class="btn btn-secondary" style="width:auto; padding:5px 15px;" onclick="document.getElementById('verify-modal').classList.add('hidden')">Close</button>
            </div>
            
            <div id="verify-warning" style="padding:10px; background:rgba(233,69,96,0.2); color:#e94560; border-radius:5px; margin-bottom:10px; font-size:0.85rem; display:none;">
                 This seed is currently active! Rotate your seed to reveal the server secret.
            </div>

            <div class="pf-field">
                <label>Game</label>
                <div class="pf-val-box" id="verify-game-name">-</div>
            </div>
            <div class="pf-field">
                <label>Data / Tickets</label>
                <div class="pf-val-box" id="verify-result" style="color:#fff; font-weight:bold; font-size:0.9rem; max-height:150px; overflow-y:auto; white-space: pre-wrap;">-</div>
            </div>
            <div class="pf-field">
                <label>Client Seed</label>
                <div class="pf-val-box" id="verify-client">-</div>
            </div>
            <div class="pf-field">
                <label>Nonce</label>
                <div class="pf-val-box" id="verify-nonce">-</div>
            </div>
            <div class="pf-field">
                <label>Server Seed</label>
                <div class="pf-val-box" id="verify-server" style="color:#e94560;">-</div>
            </div>
            <div style="margin-top:15px; text-align:center;">
                 <a onclick="showGuideFromModal()" style="color:#00e701; text-decoration:underline; font-weight:bold; cursor:pointer;"> How to verify this?</a>
            </div>
        </div>
    </div>

    <div id="guide-modal" class="modal-overlay hidden" onclick="if(event.target.id==='guide-modal') document.getElementById('guide-modal').classList.add('hidden')">
        <div class="modal-content" style="max-width:800px; height:85vh; text-align:left;">
            <div class="modal-header">
                <h3 style="margin:0"> Fairness & Verification Guide</h3>
                <button class="btn btn-secondary" style="width:auto; padding:5px 15px;" onclick="document.getElementById('guide-modal').classList.add('hidden')">Close</button>
            </div>
            
            <div class="guide-tabs">
                <div class="guide-tab active" onclick="switchGuideTab('dice')">Dice</div>
                <div class="guide-tab" onclick="switchGuideTab('cases')">Cases</div>
                <div class="guide-tab" onclick="switchGuideTab('battles')">Battles</div>
                <div class="guide-tab" onclick="switchGuideTab('bj')">Blackjack</div>
            </div>

            <div style="overflow-y:auto; flex:1; padding-right:5px;">
                <div id="guide-dice" class="guide-section active">
                    <p class="guide-p">The <strong>Dice</strong> game uses a secure chain to determine the roll (0.00 to 100.00).</p>
                    
                    <h4 style="color:#fff; border-bottom:1px solid #2f4553; padding-bottom:5px; margin-top:20px;">On-Site Verifier</h4>
                    <div class="input-group">
                        <label>Server Seed</label> <input type="text" id="calc-dice-server">
                        <label style="margin-top:5px">Client Seed</label> <input type="text" id="calc-dice-client">
                        <label style="margin-top:5px">Nonce</label> <input type="number" id="calc-dice-nonce">
                        <button class="btn btn-primary" style="margin-top:10px" onclick="GuideCalc.dice()">Verify Dice Roll</button>
                        <div id="calc-dice-res" style="margin-top:10px; color:#00e701; font-weight:bold; min-height:1.2em"></div>
                    </div>

                    <h4 style="color:#fff; border-bottom:1px solid #2f4553; padding-bottom:5px; margin-top:20px;">Manual Console Script</h4>
                    <div class="code-block">
const serverSeed = "YOUR_SERVER_SEED";
const clientSeed = "YOUR_CLIENT_SEED";
const nonce = 1;

(async () => {
    const msg = `${clientSeed}-${nonce}`;
    const enc = new TextEncoder();
    const key = await crypto.subtle.importKey('raw', enc.encode(serverSeed), {name: 'HMAC', hash: 'SHA-256'}, false, ['sign']);
    const sig = await crypto.subtle.sign('HMAC', key, enc.encode(msg));
    const hash = Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2,'0')).join('');
    
    const sub = hash.substring(0, 8);
    const intVal = parseInt(sub, 16);
    const roll = (intVal / 4294967296) * 100;
    console.log("Roll Result:", roll.toFixed(2));
})();
                    </div>
                </div>

                <div id="guide-cases" class="guide-section">
                    <p class="guide-p"><strong>Cases</strong> generate a single "Ticket" (float 0.0-1.0) for the item opened.</p>
                    
                    <h4 style="color:#fff; border-bottom:1px solid #2f4553; padding-bottom:5px; margin-top:20px;">On-Site Verifier</h4>
                    <div class="input-group">
                        <label>Server Seed</label> <input type="text" id="calc-case-server">
                        <label style="margin-top:5px">Client Seed</label> <input type="text" id="calc-case-client">
                        <label style="margin-top:5px">Nonce</label> <input type="number" id="calc-case-nonce">
                        <button class="btn btn-primary" style="margin-top:10px" onclick="GuideCalc.cases()">Verify Ticket %</button>
                        <div id="calc-case-res" style="margin-top:10px; color:#00e701; font-weight:bold; min-height:1.2em"></div>
                    </div>
                </div>

                <div id="guide-battles" class="guide-section">
                    <p class="guide-p"><strong>Box Battles</strong> generate multiple tickets. We generate one float for each player for each round. The order is: Round 1 (Player 1, Player 2...), Round 2 (Player 1, Player 2...), etc.</p>
                    
                    <h4 style="color:#fff; border-bottom:1px solid #2f4553; padding-bottom:5px; margin-top:20px;">Battle Verifier</h4>
                    <div class="input-group">
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1"><label>Rounds</label><input type="number" id="calc-bat-rounds" value="1"></div>
                            <div style="flex:1"><label>Players</label><input type="number" id="calc-bat-players" value="2"></div>
                        </div>
                        <label style="margin-top:5px">Server Seed</label> <input type="text" id="calc-bat-server">
                        <label style="margin-top:5px">Client Seed</label> <input type="text" id="calc-bat-client">
                        <label style="margin-top:5px">Nonce</label> <input type="number" id="calc-bat-nonce">
                        <button class="btn btn-primary" style="margin-top:10px" onclick="GuideCalc.battle()">Verify Full Battle</button>
                        <div id="calc-bat-res" style="margin-top:10px; color:#00e701; font-weight:bold; min-height:1.2em; white-space:pre-wrap; max-height:200px; overflow-y:auto; font-size:0.8rem; background:#000; padding:5px;"></div>
                    </div>
                </div>

                <div id="guide-bj" class="guide-section">
                    <p class="guide-p"><strong>Blackjack</strong> uses a <strong>Deterministic Fisher-Yates Shuffle</strong>. The hash of the seed pair is converted into an integer which acts as the seed for a pseudo-random number generator (Mulberry32).</p>
                    
                    <h4 style="color:#fff; border-bottom:1px solid #2f4553; padding-bottom:5px; margin-top:20px;">On-Site Verifier</h4>
                    <div class="input-group">
                        <label>Server Seed</label> <input type="text" id="calc-bj-server">
                        <label style="margin-top:5px">Client Seed</label> <input type="text" id="calc-bj-client">
                        <label style="margin-top:5px">Nonce</label> <input type="number" id="calc-bj-nonce">
                        <button class="btn btn-primary" style="margin-top:10px" onclick="GuideCalc.bj()">Verify Shuffle (First 52 Cards)</button>
                        <div id="calc-bj-res" style="margin-top:10px; color:#00e701; font-weight:bold; min-height:1.2em; white-space:pre-wrap;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div id="live-stats-popup" class="live-stats-popup hidden">
        <div class="ls-header draggable-header" id="ls-header">
            <div class="ls-title"> Live Stats</div>
            <div class="ls-controls">
                <button class="ls-btn" title="Reset Stats" onclick="LiveStats.reset()"></button>
                <button class="ls-btn" title="Close" onclick="LiveStats.toggle()"></button>
            </div>
        </div>
        <div class="ls-content">
            <div class="ls-grid">
                <div class="ls-stat">
                    <span class="ls-label">Profit</span>
                    <span class="ls-value ls-green" id="ls-profit">$0.00</span>
                </div>
                <div class="ls-stat">
                    <span class="ls-label">Wins</span>
                    <span class="ls-value ls-green" id="ls-wins">0</span>
                </div>
                <div class="ls-stat">
                    <span class="ls-label">Wagered</span>
                    <span class="ls-value" id="ls-wagered">$0.00</span>
                </div>
                <div class="ls-stat">
                    <span class="ls-label">Losses</span>
                    <span class="ls-value ls-red" id="ls-losses">0</span>
                </div>
                <div class="ls-stat" style="grid-column: span 2; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 6px; text-align: center; border: 1px solid rgba(255,255,255,0.05);">
                    <span class="ls-label">Realized Edge (RTP)</span>
                    <span class="ls-value" id="ls-edge">0.00%</span>
                </div>
            </div>
            <div class="ls-chart-container">
                <canvas id="liveStatsChart"></canvas>
            </div>
        </div>
        <div class="ls-footer">
            <span>Session Status</span>
            <span style="color:#00e701;">Active</span>
        </div>
    </div>
    <div class="footer">
        Pro Arcade Simulator &copy; 2026 &nbsp;&bull;&nbsp; <a onclick="document.getElementById('guide-modal').classList.remove('hidden')">Provably Fair & Verification Guide</a>
    </div>

<script>
    // --- USER SYSTEM (LSS) ---
    const UserSystem = {
        isLoggedIn: false,
        username: "Guest",
        key: "proArcade_v1",
        
        init: function() {
            const data = localStorage.getItem(this.key);
            if(data) {
                const parsed = JSON.parse(data);
                this.username = parsed.username;
                balance = parsed.balance;
                gameHistory = parsed.history || [];
                // Load seeds if exist
                if(parsed.seeds) {
                    ProvablyFair.clientSeed = parsed.seeds.client;
                    ProvablyFair.serverSeed = parsed.seeds.server;
                    ProvablyFair.serverHash = parsed.seeds.hash;
                    ProvablyFair.nonce = parsed.seeds.nonce;
                }
                this.isLoggedIn = true;
                this.updateUI();
            } else {
                this.isLoggedIn = false;
            }
            // Always init PF if not loaded
            if(!ProvablyFair.serverSeed) ProvablyFair.init();
            updateBalanceUI();
        },

        login: function() {
            const nameInput = document.getElementById('login-username').value;
            if(!nameInput) return alert("Enter a username");
            this.username = nameInput;
            this.isLoggedIn = true;
            this.save();
            this.updateUI();
            document.getElementById('login-modal').classList.add('hidden');
            AudioEngine.win(); 
        },

        logout: function() {
            this.isLoggedIn = false;
            this.username = "Guest";
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('user-section').classList.add('hidden');
            alert("Logged out. (Data is still saved in browser)");
        },

        reset: function() {
            if(confirm("Are you sure? This deletes all history and coins.")) {
                localStorage.removeItem(this.key);
                location.reload();
            }
        },

        save: function() {
            if(!this.isLoggedIn) return;
            const data = {
                username: this.username,
                balance: balance,
                history: gameHistory,
                seeds: {
                    client: ProvablyFair.clientSeed,
                    server: ProvablyFair.serverSeed,
                    hash: ProvablyFair.serverHash,
                    nonce: ProvablyFair.nonce
                }
            };
            localStorage.setItem(this.key, JSON.stringify(data));
        },

        checkLogin: function() {
            if(!this.isLoggedIn) {
                openLogin();
                return false;
            }
            return true;
        },

        updateUI: function() {
            if(this.isLoggedIn) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('user-section').classList.remove('hidden');
                document.getElementById('display-username').innerText = this.username;
            }
        }
    };

    function openLogin() {
        document.getElementById('login-modal').classList.remove('hidden');
    }

    // --- AUDIO SYSTEM ---
    const AudioEngine = {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        playTone: function(freq, type, duration, vol=0.1, ramp=true) {
            if (this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            if(ramp) gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.start(); osc.stop(this.ctx.currentTime + duration);
        },
        ui: function() { this.playTone(600, 'sine', 0.05, 0.03); },
        tick: function() { this.playTone(800, 'square', 0.03, 0.03); },
        roll: function() { 
            if (this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.frequency.setValueAtTime(200, this.ctx.currentTime);
            osc.frequency.linearRampToValueAtTime(50, this.ctx.currentTime + 0.5);
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.5);
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start();
        },
        win: function() { 
            this.playTone(523.25, 'triangle', 0.4, 0.1); 
            setTimeout(() => this.playTone(659.25, 'triangle', 0.4, 0.1), 100); 
            setTimeout(() => this.playTone(783.99, 'triangle', 0.6, 0.1), 200); 
        },
        lose: function() { this.playTone(100, 'sawtooth', 0.4, 0.1); },
        card: function() { this.playTone(1200, 'sine', 0.05, 0.05); setTimeout(() => this.playTone(1000, 'sine', 0.05, 0.03), 20); },
        chip: function() { this.playTone(2000, 'triangle', 0.05, 0.05); }
    };

    // --- GLOBAL STATE ---
    let balance = 20.00;
    let balanceHistory = [20.00];
    let turnLabels = ["Start"];
    let myChart = null;
    let gameHistory = [];
    let currentVerifyIndex = -1;

    // --- PROVABLY FAIR ENGINE ---
    const ProvablyFair = {
        serverSeed: null,
        serverHash: null,
        clientSeed: 'dice-sim-client',
        nonce: 1, 
        
        generateHex: function(len) {
            const arr = new Uint8Array(len/2);
            window.crypto.getRandomValues(arr);
            return Array.from(arr).map(b => b.toString(16).padStart(2,'0')).join('');
        },
        sha256: async function(msg) {
            const encoder = new TextEncoder();
            const data = encoder.encode(msg);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
        },
        hmacSha256: async function(key, msg) {
            const encoder = new TextEncoder();
            const keyData = encoder.encode(key);
            const msgData = encoder.encode(msg);
            const cryptoKey = await crypto.subtle.importKey('raw', keyData, {name: 'HMAC', hash: 'SHA-256'}, false, ['sign']);
            const sig = await crypto.subtle.sign('HMAC', cryptoKey, msgData);
            return Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2,'0')).join('');
        },

        init: async function() {
            this.serverSeed = this.generateHex(64);
            this.serverHash = await this.sha256(this.serverSeed);
            this.updateUI();
        },
        
        saveClientSeed: function() {
            const val = document.getElementById('pf-client-seed').value;
            if(val.length < 1) return alert("Client seed cannot be empty");
            this.clientSeed = val;
            this.nonce = 1; 
            alert("Client seed updated. Nonce reset to 1.");
            this.updateUI();
            UserSystem.save();
        },

        rotateSeed: async function() {
            const oldSeed = this.serverSeed;
            const oldHash = this.serverHash;
            this.serverSeed = this.generateHex(64);
            this.serverHash = await this.sha256(this.serverSeed);
            this.nonce = 1;
            document.getElementById('pf-prev-data').classList.remove('hidden');
            document.getElementById('pf-prev-seed').innerText = oldSeed;
            document.getElementById('pf-prev-hash').innerText = oldHash;
            this.updateUI();
            UserSystem.save(); // Save new seed
            
            // Refresh Verify Modal if open
            if(!document.getElementById('verify-modal').classList.contains('hidden') && currentVerifyIndex !== -1) {
                verifyGame(currentVerifyIndex);
            }
        },

        generate: async function(count = 1, type = 'float') {
            const results = [];
            const startNonce = this.nonce;
            const currentServer = this.serverSeed;
            const currentClient = this.clientSeed;
            
            for(let i=0; i<count; i++) {
                const msg = `${currentClient}-${this.nonce}`;
                const hash = await this.hmacSha256(currentServer, msg);
                const sub = hash.substring(0, 8);
                const intVal = parseInt(sub, 16);
                let val;
                if(type === 'dice') val = (intVal / 4294967296) * 100;
                else val = (intVal / 4294967296);
                results.push(val);
                this.nonce++;
            }
            this.updateUI();
            UserSystem.save(); // Save nonce increment
            return { values: results, nonce: startNonce, serverSeed: currentServer, clientSeed: currentClient };
        },
        
        generateDeckShuffle: async function(deckArray) {
            const startNonce = this.nonce;
            const currentServer = this.serverSeed;
            const currentClient = this.clientSeed;
            const msg = `${currentClient}-${this.nonce}`;
            const hash = await this.hmacSha256(currentServer, msg);
            let seed = parseInt(hash.substring(0,8), 16);
            const random = () => { let t = seed += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; }
            for (let i = deckArray.length - 1; i > 0; i--) { const j = Math.floor(random() * (i + 1)); [deckArray[i], deckArray[j]] = [deckArray[j], deckArray[i]]; }
            this.nonce++;
            this.updateUI();
            UserSystem.save(); // Save nonce increment
            return { deck: deckArray, nonce: startNonce, serverSeed: currentServer, clientSeed: currentClient, seedHash: hash };
        },

        updateUI: function() {
            document.getElementById('pf-client-seed').value = this.clientSeed;
            document.getElementById('pf-server-hash').innerText = this.serverHash || "Generating...";
            document.getElementById('pf-nonce').innerText = this.nonce;
        },

        openModal: function() {
            AudioEngine.ui();
            document.getElementById('pf-modal').classList.remove('hidden');
        }
    };
    
    // Init PF on load
    ProvablyFair.init();

    // --- GUIDE MODAL LOGIC ---
    function switchGuideTab(tab) {
        document.querySelectorAll('.guide-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.guide-section').forEach(s => s.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`guide-${tab}`).classList.add('active');
    }

    function showGuideFromModal() {
        document.getElementById('verify-modal').classList.add('hidden');
        document.getElementById('guide-modal').classList.remove('hidden');
    }

    const GuideCalc = {
        dice: async function() {
            const s = document.getElementById('calc-dice-server').value;
            const c = document.getElementById('calc-dice-client').value;
            const n = document.getElementById('calc-dice-nonce').value;
            if(!s || !c || !n) return;
            const msg = `${c}-${n}`;
            const hash = await ProvablyFair.hmacSha256(s, msg);
            const sub = hash.substring(0, 8);
            const val = (parseInt(sub, 16) / 4294967296) * 100;
            document.getElementById('calc-dice-res').innerText = `Result: ${val.toFixed(2)}`;
        },
        cases: async function() {
            const s = document.getElementById('calc-case-server').value;
            const c = document.getElementById('calc-case-client').value;
            const n = document.getElementById('calc-case-nonce').value;
            if(!s || !c || !n) return;
            const msg = `${c}-${n}`;
            const hash = await ProvablyFair.hmacSha256(s, msg);
            const sub = hash.substring(0, 8);
            const val = (parseInt(sub, 16) / 4294967296);
            document.getElementById('calc-case-res').innerText = `Ticket: ${(val * 100).toFixed(6)}%`;
        },
        battle: async function() {
            const s = document.getElementById('calc-bat-server').value;
            const c = document.getElementById('calc-bat-client').value;
            let n = parseInt(document.getElementById('calc-bat-nonce').value);
            const rounds = parseInt(document.getElementById('calc-bat-rounds').value);
            const players = parseInt(document.getElementById('calc-bat-players').value);
            if(!s || !c || !n) return;
            
            let output = "";
            
            // Logic must match startBattle: 
            // 1. Generate (rounds * players) floats
            // 2. Assign floats: P1 gets (0 to R-1), P2 gets (R to 2R-1)
            
            const totalOps = rounds * players;
            const allFloats = [];
            
            for(let i=0; i<totalOps; i++) {
                const msg = `${c}-${n}`;
                const hash = await ProvablyFair.hmacSha256(s, msg);
                const sub = hash.substring(0, 8);
                const val = (parseInt(sub, 16) / 4294967296);
                allFloats.push(val);
                n++; // Simulate nonce increment
            }
            
            let fIdx = 0;
            for(let p=1; p<=players; p++) {
                output += `\nPlayer ${p}:\n`;
                for(let r=1; r<=rounds; r++) {
                    const ticket = allFloats[fIdx++];
                    output += `  Round ${r}: ${(ticket*100).toFixed(6)}%\n`;
                }
            }
            
            document.getElementById('calc-bat-res').innerText = output;
        },
        bj: async function() {
            const s = document.getElementById('calc-bj-server').value;
            const c = document.getElementById('calc-bj-client').value;
            const n = document.getElementById('calc-bj-nonce').value;
            if(!s || !c || !n) return;
            const deck = []; const suits = ['', '', '', '']; const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
            for(let i=0; i<6; i++) { for (let s of suits) { for (let v of values) { deck.push(`${v}${s}`); } } }
            const msg = `${c}-${n}`;
            const hash = await ProvablyFair.hmacSha256(s, msg);
            let seed = parseInt(hash.substring(0,8), 16);
            const random = () => { let t = seed += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), t | 1); t ^= t + Math.imul(t ^ (t >>> 7), t | 61); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; }
            for (let i = deck.length - 1; i > 0; i--) { const j = Math.floor(random() * (i + 1)); [deck[i], deck[j]] = [deck[j], deck[i]]; }
            const top52 = deck.slice(-52).reverse();
            document.getElementById('calc-bj-res').innerText = `Full Deck Order (First 52):\n${top52.join(', ')}`;
        }
    };


// --- LIVE STATS SYSTEM (With EV & Full History) ---
    const LiveStats = {
        profit: 0,
        wagered: 0,
        wins: 0,
        losses: 0,
        chart: null,
        history: [0], 
        
        init: function() {
            // Dragging Logic
            const el = document.getElementById('live-stats-popup');
            const header = document.getElementById('ls-header');
            let isDragging = false, offsetX, offsetY;

            header.onmousedown = (e) => {
                isDragging = true;
                offsetX = e.clientX - el.offsetLeft;
                offsetY = e.clientY - el.offsetTop;
                el.style.transition = 'none'; 
            };
            document.onmousemove = (e) => {
                if (isDragging) {
                    el.style.left = (e.clientX - offsetX) + 'px';
                    el.style.top = (e.clientY - offsetY) + 'px';
                    el.style.right = 'auto'; 
                }
            };
            document.onmouseup = () => { isDragging = false; };

            // Chart Setup
            const ctx = document.getElementById('liveStatsChart').getContext('2d');
            this.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Start'],
                    datasets: [{
                        data: [0],
                        borderColor: '#00e701',
                        borderWidth: 2,
                        backgroundColor: 'rgba(0, 231, 1, 0.1)',
                        fill: true,
                        pointRadius: 0, 
                        pointHoverRadius: 4,
                        tension: 0.1
                    }]
                },
                options: {
                    plugins: { legend: { display: false }, tooltip: { enabled: true, mode: 'index', intersect: false } },
                    scales: { x: { display: false }, y: { display: false, min: null } },
                    animation: false,
                    maintainAspectRatio: false,
                    responsive: true
                }
            });
        },

        update: function(profit, wager, isWin) {
            this.profit += profit;
            this.wagered += wager;
            if(isWin) this.wins++; else this.losses++;
            
            // 1. Basic Stats
            const pEl = document.getElementById('ls-profit');
            pEl.innerText = (this.profit >= 0 ? "+$" : "-$") + Math.abs(this.profit).toFixed(2);
            pEl.className = "ls-value " + (this.profit >= 0 ? "ls-green" : "ls-red");
            
            document.getElementById('ls-wagered').innerText = "$" + this.wagered.toFixed(2);
            document.getElementById('ls-wins').innerText = this.wins;
            document.getElementById('ls-losses').innerText = this.losses;

            // 2. Calculate Realized Edge % (Profit / Wagered)
            let edge = 0;
            if (this.wagered > 0) {
                edge = (this.profit / this.wagered) * 100;
            }
            
            const edgeEl = document.getElementById('ls-edge');
            edgeEl.innerText = (edge >= 0 ? "+" : "") + edge.toFixed(2) + "%";
            edgeEl.className = "ls-value " + (edge >= 0 ? "ls-green" : "ls-red");

            // 3. Update Chart (Accumulate ALL history)
            this.history.push(this.profit);
            this.chart.data.labels = this.history.map((_, i) => i);
            this.chart.data.datasets[0].data = this.history;
            
            const color = this.profit >= 0 ? '#00e701' : '#ff4d4d';
            this.chart.data.datasets[0].borderColor = color;
            this.chart.data.datasets[0].backgroundColor = this.profit >= 0 ? 'rgba(0, 231, 1, 0.1)' : 'rgba(255, 77, 77, 0.1)';
            
            this.chart.update();
        },

        reset: function() {
            this.profit = 0; this.wagered = 0; this.wins = 0; this.losses = 0; this.history = [0];
            
            document.getElementById('ls-profit').innerText = "$0.00";
            document.getElementById('ls-profit').className = "ls-value ls-green";
            document.getElementById('ls-wagered').innerText = "$0.00";
            document.getElementById('ls-wins').innerText = "0";
            document.getElementById('ls-losses').innerText = "0";
            document.getElementById('ls-edge').innerText = "0.00%";
            document.getElementById('ls-edge').className = "ls-value";

            this.chart.data.labels = ['Start'];
            this.chart.data.datasets[0].data = [0];
            this.chart.data.datasets[0].borderColor = '#00e701';
            this.chart.data.datasets[0].backgroundColor = 'rgba(0, 231, 1, 0.1)';
            this.chart.update();
        },

        toggle: function() {
            const el = document.getElementById('live-stats-popup');
            if(el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                if(!this.chart) this.init(); 
            } else {
                el.classList.add('hidden');
            }
        }
    };
    
    // Init on load
    setTimeout(() => LiveStats.init(), 500);
// --- DICE LOGIC (AUTO & MANUAL) ---
    const HOUSE_EDGE = 1.0; 
    let autoActive = false;
    let autoConfig = { onWin: 'reset', onLoss: 'reset', winInc: 0, lossInc: 0 };

    function setDiceMode(mode) {
        AudioEngine.ui();
        document.getElementById('btn-dice-manual').classList.toggle('active', mode === 'manual');
        document.getElementById('btn-dice-auto').classList.toggle('active', mode === 'auto');
        
        if(mode === 'manual') {
            document.getElementById('dice-manual-panel').classList.remove('hidden');
            document.getElementById('dice-auto-panel').classList.add('hidden');
            document.getElementById('dice-roll-btn').innerText = "BET (ROLL)";
            document.getElementById('dice-roll-btn').classList.remove('btn-danger');
            document.getElementById('dice-roll-btn').classList.add('btn-primary');
            autoActive = false;
        } else {
            document.getElementById('dice-manual-panel').classList.add('hidden');
            document.getElementById('dice-auto-panel').classList.remove('hidden');
            document.getElementById('dice-roll-btn').innerText = "START AUTO";
        }
    }

    function setAutoAction(type, action, btn) {
        AudioEngine.ui();
        autoConfig[type === 'win' ? 'onWin' : 'onLoss'] = action;
        
        const inputId = type === 'win' ? 'auto-win-inc' : 'auto-loss-inc';
        if(action === 'increase') document.getElementById(inputId).classList.remove('hidden');
        else document.getElementById(inputId).classList.add('hidden');

        const parent = btn.parentElement;
        Array.from(parent.children).forEach(b => {
            if(b.tagName === 'BUTTON') b.classList.remove('active');
        });
        btn.classList.add('active');
    }

    function handleDiceAction() {
        const isAuto = document.getElementById('btn-dice-auto').classList.contains('active');
        if (isAuto) {
            if (autoActive) stopAutoDice();
            else startAutoDice();
        } else {
            rollDice(); 
        }
    }

    async function startAutoDice() {
        if(!UserSystem.checkLogin()) return;
        autoActive = true;
        const btn = document.getElementById('dice-roll-btn');
        btn.innerText = "STOP AUTO";
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-danger');

        autoConfig.winInc = parseFloat(document.getElementById('auto-win-inc').value) || 0;
        autoConfig.lossInc = parseFloat(document.getElementById('auto-loss-inc').value) || 0;
        
        const countInput = document.getElementById('auto-count');
        const baseWager = parseFloat(document.getElementById('dice-wager').value);

        while (autoActive) {
            // Counter Logic
            let currentCount = parseInt(countInput.value);
            
            // Only countdown if it's a valid number > 0
            if (!isNaN(currentCount) && currentCount > 0) {
                currentCount--;
                countInput.value = currentCount;
                if (currentCount < 0) { stopAutoDice(); break; }
            } else if (currentCount === 0 && countInput.value !== "") {
                // If it hits exactly 0 from counting down, stop
                stopAutoDice(); break; 
            }

            const result = await rollDice(true); // IsAuto = true
            
            if (!result || !autoActive) break; 

            // Strategy Logic
            let currentWager = parseFloat(document.getElementById('dice-wager').value);
            
            if (result.win) {
                if (autoConfig.onWin === 'reset') currentWager = baseWager;
                else currentWager = currentWager * (1 + (autoConfig.winInc / 100));
            } else {
                if (autoConfig.onLoss === 'reset') currentWager = baseWager;
                else currentWager = currentWager * (1 + (autoConfig.lossInc / 100));
            }

            if (currentWager < 0.01) currentWager = 0.01;
            if (currentWager > balance) currentWager = balance; 

            document.getElementById('dice-wager').value = currentWager.toFixed(2);
            updateDiceCalculations();

            // SPEED: 50ms delay
            await new Promise(r => setTimeout(r, 50)); 
        }
        stopAutoDice();
    }

    function stopAutoDice() {
        autoActive = false;
        const btn = document.getElementById('dice-roll-btn');
        btn.innerText = "START AUTO";
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-primary');
    }

    function adjustDiceBet(mult) { let val = parseFloat(document.getElementById('dice-wager').value); val = val * mult; if(val < 0.01) val = 0.01; document.getElementById('dice-wager').value = val.toFixed(2); updateDiceCalculations(); }
    function updateDiceFromSlider() { AudioEngine.ui(); let target = parseFloat(document.getElementById('dice-slider').value); let chance = 100 - target; let mult = (100 - HOUSE_EDGE) / chance; document.getElementById('dice-target').value = target.toFixed(2); document.getElementById('dice-chance').value = chance.toFixed(2); document.getElementById('dice-mult').value = mult.toFixed(4); updateDiceCalculations(true); }
    function updateDiceFromMult() { let mult = parseFloat(document.getElementById('dice-mult').value); if(mult < 1.01) mult = 1.01; let chance = (100 - HOUSE_EDGE) / mult; let target = 100 - chance; document.getElementById('dice-chance').value = chance.toFixed(2); document.getElementById('dice-target').value = target.toFixed(2); document.getElementById('dice-slider').value = target; updateDiceCalculations(true); }
    function updateDiceFromChance() { let chance = parseFloat(document.getElementById('dice-chance').value); if(chance > 98) chance = 98; if(chance < 0.01) chance = 0.01; let target = 100 - chance; let mult = (100 - HOUSE_EDGE) / chance; document.getElementById('dice-target').value = target.toFixed(2); document.getElementById('dice-slider').value = target; document.getElementById('dice-mult').value = mult.toFixed(4); updateDiceCalculations(true); }
    function updateDiceFromTarget() { let target = parseFloat(document.getElementById('dice-target').value); let chance = 100 - target; let mult = (100 - HOUSE_EDGE) / chance; document.getElementById('dice-slider').value = target; document.getElementById('dice-chance').value = chance.toFixed(2); document.getElementById('dice-mult').value = mult.toFixed(4); updateDiceCalculations(true); }
    function updateDiceCalculations(skipInputs) { let wager = parseFloat(document.getElementById('dice-wager').value); let mult = parseFloat(document.getElementById('dice-mult').value); let profit = (wager * mult) - wager; document.getElementById('dice-profit-display').value = profit.toFixed(2); let sliderVal = document.getElementById('dice-slider').value; document.getElementById('dice-win-bar').style.width = (100 - sliderVal) + "%"; }
    
    async function rollDice(isAuto = false) {
        if(!UserSystem.checkLogin()) { if(isAuto) stopAutoDice(); return null; }
        
        let wager = parseFloat(document.getElementById('dice-wager').value); 
        if(wager > balance) { 
            if(isAuto) { stopAutoDice(); alert("Auto stopped: Insufficient funds"); } 
            else alert("Insufficient funds"); 
            return null; 
        }
        
        // SOUND FIX: Tick for Auto, Sweep for Manual
        if(isAuto) AudioEngine.tick(); 
        else AudioEngine.roll(); 
        
        let pfData = await ProvablyFair.generate(1, 'dice'); 
        let roll = pfData.values[0].toFixed(2); 
        let target = parseFloat(document.getElementById('dice-target').value); 
        let win = parseFloat(roll) > target;
        
        balance -= wager; 
        const marker = document.getElementById('dice-result-marker'); 
        marker.style.opacity = '1'; marker.style.left = roll + "%"; marker.innerText = roll; 
        
        let pDataDisplay = { result: roll, ...pfData }; 
        let payout = 0;

        if(win) { 
            let mult = parseFloat(document.getElementById('dice-mult').value); 
            payout = wager * mult; 
            balance += payout; 
            marker.style.color = '#00e701'; marker.style.border = '2px solid #00e701'; 
            
            // SOUND FIX: Short ping for Auto
            if(isAuto) AudioEngine.playTone(784, 'triangle', 0.1, 0.1); 
            else setTimeout(() => AudioEngine.win(), 300);
            
            logGame('Dice', 'Win', payout - wager, wager, pDataDisplay);
        } else { 
            marker.style.color = '#ff4d4d'; marker.style.border = '2px solid #ff4d4d'; 
            
            // SOUND FIX: Short bloop for Auto
            if(isAuto) AudioEngine.playTone(100, 'sawtooth', 0.1, 0.1);
            else setTimeout(() => AudioEngine.lose(), 300); 
            
            logGame('Dice', 'Loss', -wager, wager, pDataDisplay); 
        }
        
        updateBalanceUI(); trackHistory(); UserSystem.save();
        
        return { win: win, payout: payout };
    }

// --- CS2 SKINS DATABASE (Fixed Images) ---
const casesDB = [
  // 1. THE 1% Dream (Image: AWP Dragon Lore)
  { 
    id: 0, 
    name: "The 1% Dream", 
    cost: 105.00, 
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_awp_cu_medieval_dragon_awp_light_png.png", 
    items: [ 
      { name: "AWP Dragon Lore", value: 10000.00, chance: 0.01, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_awp_cu_medieval_dragon_awp_light_png.png" },
      { name: "P250 Sand Dune", value: 0.10, chance: 0.99, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_p250_so_sand_light_png.png" }
    ] 
  },

  // 2. THE 10% Shot (Image: Karambit Doppler)
  { 
    id: 1, 
    name: "The 10% Shot", 
    cost: 157.60, 
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_knife_karambit_am_emerald_marbleized_light_png.png", 
    items: [ 
      { name: "Karambit Doppler", value: 1500.00, chance: 0.10, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_knife_karambit_am_emerald_marbleized_light_png.png" },
      { name: "SG 553 Army Sheen", value: 0.10, chance: 0.90, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_sg556_am_army_shine_light_png.png" }
    ] 
  },

  // 3. THE 50/50 (Image: AWP Asiimov)
  {
    id: 2,
    name: "Fifty-Fifty",
    cost: 52.50,
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_awp_cu_awp_asimov_medium_png.png",
    items: [
      { name: "AWP Asiimov", value: 100.00, chance: 0.50, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_awp_cu_awp_asimov_medium_png.png" },
      { name: "MP9 Capillary", value: 0.10, chance: 0.50, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_mp9_cu_mp9_vein_light_png.png" }
    ]
  },

  // 4. BUDGET LOADOUT (Image: AK-47 Redline)
  {
    id: 3,
    name: "Budget Loadout",
    cost: 10.00,
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak47_cobra_light_png.png",
    items: [
      { name: "AK-47 Redline", value: 30.00, chance: 0.10, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak47_cobra_light_png.png" },
      { name: "AWP Atheris", value: 15.00, chance: 0.15, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_awp_cu_awp_viper_light_png.png" },
      { name: "M4A4 Desolate Space", value: 12.00, chance: 0.20, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_m4a1_cu_m4a4_desolate_space_light_png.png" },
      { name: "Glock-18 Water Elemental", value: 10.00, chance: 0.20, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_glock_cu_glock-liquescent_light_png.png" },
      { name: "USP-S Cortex", value: 8.00, chance: 0.20, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_usp_silencer_cu_usp_cut_light_png.png" },
      { name: "SCAR-20 Grotto", value: 0.10, chance: 0.15, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_scar20_aq_scar20_leak_light_png.png" }
    ]
  },

  // 5. PISTOL ROUND (Image: Glock-18 Fade)
  {
    id: 4,
    name: "Pistol Round",
    cost: 40.85,
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_glock_aa_fade_light_png.png",
    items: [
      { name: "Glock-18 Fade", value: 1200.00, chance: 0.01, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_glock_aa_fade_light_png.png" },
      { name: "Desert Eagle Blaze", value: 800.00, chance: 0.02, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_deagle_aa_flames_light_png.png" },
      { name: "USP-S Kill Confirmed", value: 150.00, chance: 0.05, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_usp_silencer_cu_usp_kill_confirmed_light_png.png" },
      { name: "Desert Eagle Printstream", value: 80.00, chance: 0.10, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_deagle_cu_deag_printstream_light_png.png" },
      { name: "Glock-18 Water Elemental", value: 10.00, chance: 0.40, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_glock_cu_glock-liquescent_light_png.png" },
      { name: "USP-S Cortex", value: 8.00, chance: 0.30, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_usp_silencer_cu_usp_cut_light_png.png" },
      { name: "P250 Sand Dune", value: 0.10, chance: 0.12, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_p250_so_sand_light_png.png" }
    ]
  },

  // 6. REDLINE CASE (Image: AK-47 Wild Lotus)
  {
    id: 5,
    name: "Redline Case",
    cost: 81.50,
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak_island_floral_light_png.png",
    items: [
      { name: "M4A4 Howl", value: 4000.00, chance: 0.005, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_m4a1_cu_m4a1_howling_light_png.png" },
      { name: "AK-47 Wild Lotus", value: 8000.00, chance: 0.002, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak_island_floral_light_png.png" },
      { name: "USP-S Kill Confirmed", value: 150.00, chance: 0.10, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_usp_silencer_cu_usp_kill_confirmed_light_png.png" },
      { name: "AK-47 Redline", value: 30.00, chance: 0.40, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak47_cobra_light_png.png" },
      { name: "Glock-18 Water Elemental", value: 10.00, chance: 0.30, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_glock_cu_glock-liquescent_light_png.png" },
      { name: "PP-Bizon Sand Dashed", value: 0.05, chance: 0.193, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_bizon_sp_tape_short_sand_light_png.png" }
    ]
  },

  // 7. SNIPER'S NEST (Image: AWP Dragon Lore)
  {
    id: 6,
    name: "Sniper's Nest",
    cost: 155.00,
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_awp_cu_medieval_dragon_awp_light_png.png",
    items: [
      { name: "AWP Dragon Lore", value: 10000.00, chance: 0.005, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_awp_cu_medieval_dragon_awp_light_png.png" },
      { name: "AWP Asiimov", value: 100.00, chance: 0.40, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_awp_cu_awp_asimov_medium_png.png" },
      { name: "AWP Atheris", value: 15.00, chance: 0.40, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_awp_cu_awp_viper_light_png.png" },
      { name: "SCAR-20 Grotto", value: 0.10, chance: 0.195, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_scar20_aq_scar20_leak_light_png.png" }
    ]
  },

  // 8. HEAVY HITTER (Image: AK-47 Wild Lotus)
  {
    id: 7,
    name: "Heavy Hitter",
    cost: 294.00,
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak_island_floral_light_png.png",
    items: [
      { name: "AK-47 Wild Lotus", value: 8000.00, chance: 0.01, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak_island_floral_light_png.png" },
      { name: "AK-47 Fire Serpent", value: 1000.00, chance: 0.05, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_fireserpent_ak47_bravo_light_png.png" },
      { name: "AK-47 Vulcan", value: 400.00, chance: 0.15, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak47_rubber_light_png.png" },
      { name: "M4A1-S Printstream", value: 200.00, chance: 0.20, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_m4a1_silencer_cu_m4a1s_printstream_light_png.png" },
      { name: "AK-47 Redline", value: 30.00, chance: 0.20, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak47_cobra_light_png.png" },
      { name: "SG 553 Army Sheen", value: 0.10, chance: 0.39, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_sg556_am_army_shine_light_png.png" }
    ]
  },

  // 9. THE 25% (Image: Desert Eagle Blaze)
  {
    id: 8,
    name: "The 25%",
    cost: 216.00,
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_deagle_aa_flames_light_png.png",
    items: [
      { name: "Desert Eagle Blaze", value: 800.00, chance: 0.25, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_deagle_aa_flames_light_png.png" },
      { name: "USP-S Cortex", value: 8.00, chance: 0.75, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_usp_silencer_cu_usp_cut_light_png.png" }
    ]
  },

  // 10. KNIFE CLUB (Image: Butterfly Knife Fade)
  {
    id: 9,
    name: "Knife Club",
    cost: 892.50,
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_knife_butterfly_aa_fade_light_png.png",
    items: [
      { name: "Butterfly Knife Fade", value: 3000.00, chance: 0.10, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_knife_butterfly_aa_fade_light_png.png" },
      { name: "M9 Bayonet Lore", value: 2000.00, chance: 0.15, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_knife_m9_bayonet_cu_m9_bay_lore_light_png.png" },
      { name: "Karambit Doppler", value: 1500.00, chance: 0.15, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_knife_karambit_am_emerald_marbleized_light_png.png" },
      { name: "P250 Sand Dune", value: 0.10, chance: 0.60, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_p250_so_sand_light_png.png" } 
    ]
  },

  // 11. GLOVE BOX (Image: Pandora's Box Gloves)
  {
    id: 10,
    name: "Glove Box",
    cost: 630.00,
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/sporty_gloves_sporty_purple_light_png.png",
    items: [
      { name: "Sport Gloves Pandora's Box", value: 5000.00, chance: 0.05, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/sporty_gloves_sporty_purple_light_png.png" },
      { name: "Butterfly Knife Fade", value: 3000.00, chance: 0.05, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_knife_butterfly_aa_fade_light_png.png" },
      { name: "M9 Bayonet Lore", value: 2000.00, chance: 0.05, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_knife_m9_bayonet_cu_m9_bay_lore_light_png.png" },
      { name: "MP9 Capillary", value: 0.20, chance: 0.85, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_mp9_cu_mp9_vein_light_png.png" }
    ]
  },

  // 12. DREAM INVENTORY (Image: AWP Dragon Lore)
  {
    id: 11,
    name: "Dream Inventory",
    cost: 1260.00,
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_awp_cu_medieval_dragon_awp_light_png.png",
    items: [
      { name: "AWP Dragon Lore", value: 10000.00, chance: 0.05, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_awp_cu_medieval_dragon_awp_light_png.png" },
      { name: "AK-47 Wild Lotus", value: 8000.00, chance: 0.05, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak_island_floral_light_png.png" },
      { name: "Sport Gloves Pandora's Box", value: 5000.00, chance: 0.05, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/sporty_gloves_sporty_purple_light_png.png" },
      { name: "PP-Bizon Sand Dashed", value: 0.05, chance: 0.85, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_bizon_sp_tape_short_sand_light_png.png" }
    ]
  },

  // 13. BLUE GEM (Image: AK-47 Vulcan)
  {
    id: 12,
    name: "Blue Gem",
    cost: 47.25,
    image: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak47_rubber_light_png.png",
    items: [
      { name: "AK-47 Vulcan", value: 400.00, chance: 0.05, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_ak47_cu_ak47_rubber_light_png.png" },
      { name: "M4A1-S Printstream", value: 200.00, chance: 0.10, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_m4a1_silencer_cu_m4a1s_printstream_light_png.png" },
      { name: "Desert Eagle Printstream", value: 80.00, chance: 0.15, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_deagle_cu_deag_printstream_light_png.png" },
      { name: "SCAR-20 Grotto", value: 0.10, chance: 0.70, icon: "https://cs2-cdn.pricempire.com/panorama/images/econ/default_generated/weapon_scar20_aq_scar20_leak_light_png.png" }
    ]
  }
];
// --- NEW PROFIT-BASED RARITY ---
    function getRarityClass(value, boxCost) {
        if (!boxCost || boxCost === 0) return 'rarity-gray'; // Safety check
        
        const ratio = value / boxCost;

        if (ratio >= 8.01) return 'rarity-gold';      // 8x+
        if (ratio >= 5.01) return 'rarity-red';       // 5x - 8x
        if (ratio >= 3.51) return 'rarity-pink';      // 3.5x - 5x
        if (ratio >= 2.00) return 'rarity-purple';    // 2x - 3.5x
        if (ratio >= 1.60) return 'rarity-blue';      // 1.6x - 2x
        if (ratio >= 0.91) return 'rarity-lightblue'; // 0.91x - 1.5x
        
        return 'rarity-gray';                         // 0x - 0.9x (Loss)
    }

    // --- BATTLE LOGIC ---
    let battleQueue = []; 
    let battleMode = '1v1';
    let battleType = 'standard'; 
 		let isCrazyMode = false; // <--- ADD THIS LINE HERE
    // FIX: Added colors for b4 and b5 so the game doesn't crash in 3v3
    const PLAYER_COLORS = { 
        'p': '#448aff',   // Blue
        'b1': '#e94560',  // Red
        'b2': '#00e676',  // Green
        'b3': '#ff9100',  // Orange
        'b4': '#9c27b0',  // Purple (New)
        'b5': '#00bcd4'   // Cyan (New)
    };

    function openCaseModal() {
        const modal = document.getElementById('case-modal');
        const grid = document.getElementById('modal-case-list');
        grid.innerHTML = '';
        AudioEngine.ui();
        casesDB.forEach(c => {
            const el = document.createElement('div'); el.className = 'case-select-item';
            const eye = document.createElement('div'); eye.className = 'case-inspect-btn'; eye.innerHTML = '';
            eye.onclick = (e) => { e.stopPropagation(); openInspectModal(c); };
            el.innerHTML = `<img src="${c.image}" style="width:100px; height:80px; object-fit:contain; margin-bottom:5px;"><div style="font-weight:bold; font-size:0.9rem; margin-bottom:5px;">${c.name}</div><div style="color:#e94560;">$${c.cost.toFixed(2)}</div>`;
            el.appendChild(eye);
            const ctrls = document.createElement('div'); ctrls.className = 'case-controls';
            const minus = document.createElement('button'); minus.className='ctrl-btn'; minus.innerText='-';
            minus.onclick = () => modifyQueue(c, -1);
            const plus = document.createElement('button'); plus.className='ctrl-btn'; plus.innerText='+';
            plus.onclick = () => modifyQueue(c, 1);
            const qtySpan = document.createElement('span'); qtySpan.className='qty-display'; qtySpan.id = `qty-${c.id}`;
            qtySpan.innerText = getQueueCount(c.id);
            ctrls.appendChild(minus); ctrls.appendChild(qtySpan); ctrls.appendChild(plus);
            el.appendChild(ctrls);
            grid.appendChild(el);
        });
        modal.classList.remove('hidden');
    }

    function getQueueCount(id) { return battleQueue.filter(x => x.id === id).length; }

    function modifyQueue(caseObj, change) {
        AudioEngine.ui();
        if (change > 0) {
            if (battleQueue.length >= 20) return alert("Max 20 cases!");
            battleQueue.push(caseObj);
        } else {
            const idx = battleQueue.findIndex(x => x.id === caseObj.id);
            if(idx > -1) battleQueue.splice(idx, 1);
        }
        document.getElementById(`qty-${caseObj.id}`).innerText = getQueueCount(caseObj.id);
        updateBattleQueueUI();
    }

		function openInspectModal(c) {
        const grid = document.getElementById('inspect-content'); 
        grid.innerHTML = '';
        AudioEngine.ui();
        
        c.items.forEach(item => {
             const rarity = getRarityClass(item.value, c.cost);
             const pctVal = item.chance * 100;
             const pctStr = pctVal < 0.1 ? pctVal.toFixed(3) : (pctVal < 1 ? pctVal.toFixed(2) : pctVal.toFixed(0));

             const div = document.createElement('div');
             div.className = `item-card ${rarity}`; 
             
             // Removed the div.style.cssText block here to let CSS handle it
             
             div.innerHTML = `
                <img src="${item.icon}">
                <div class="item-name">${item.name}</div>
                <div class="item-meta">
                    <span class="item-price">$${item.value.toFixed(2)}</span>
                    <span class="item-chance">${pctStr}%</span>
                </div>
             `;
             grid.appendChild(div);
        });
        document.getElementById('inspect-modal').classList.remove('hidden');
    }

		function updateBattleQueueUI() {
        const qContainer = document.getElementById('battle-cart-grid');
        qContainer.innerHTML = ''; 
        
        // Re-add "Add Box" Button
        const addBtn = document.createElement('div'); 
        addBtn.className = 'nc-add-card'; 
        addBtn.innerHTML = `<div class="nc-plus">+</div><div class="nc-add-text">Add Box</div>`;
        addBtn.onclick = () => openCaseModal();
        qContainer.appendChild(addBtn);

        const counts = {};
        battleQueue.forEach(c => { counts[c.id] = (counts[c.id] || 0) + 1; });
        let totalCost = 0;
        const uniqueIds = [...new Set(battleQueue.map(c => c.id))];
        
        uniqueIds.forEach(id => {
            const c = casesDB.find(x => x.id === id);
            const count = counts[id];
            totalCost += c.cost * count;
            
            // New Cart Item Styling
            const item = document.createElement('div'); 
            item.className = 'nc-item-card';
            item.innerHTML = `
                <div class="nc-remove" onclick="modifyQueue(casesDB[${c.id}], -1)"></div>
                <div class="nc-badge">${count}</div>
                <img src="${c.image}" class="nc-item-img">
                <div style="font-size:0.75rem; color:#8a9bb0; margin-bottom:4px; text-align:center; padding:0 5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;">${c.name}</div>
                <div class="nc-item-price">$${c.cost.toFixed(2)}</div>
            `;
            qContainer.insertBefore(item, addBtn);
        });

        // Update Summary Footer Stats
        const els = {
            cost: document.getElementById('nc-cost'),
            btnCost: document.getElementById('nc-btn-cost'),
            count: document.getElementById('nc-pack-count'),
            rounds: document.getElementById('nc-rounds')
        };
        
        if(els.cost) els.cost.innerText = `$${totalCost.toFixed(2)}`;
        if(els.btnCost) els.btnCost.innerText = `$${totalCost.toFixed(2)}`;
        if(els.count) els.count.innerText = battleQueue.length;
        if(els.rounds) els.rounds.innerText = battleQueue.length;
    }

    function clearBattleQueue() { battleQueue = []; updateBattleQueueUI(); AudioEngine.ui(); }
		function setBattleMode(mode, btn) { 
        AudioEngine.ui(); 
        battleMode = mode; 
        
        // Remove active class from all pills
        document.querySelectorAll('.nc-pill').forEach(b => b.classList.remove('active')); 
        // Add to clicked pill
        btn.classList.add('active'); 
        
        // Update Player Count in Summary
        let pCount = 2;
        if(mode === '1v1v1') pCount = 3;
        if(mode === '1v1v1v1' || mode === '2v2') pCount = 4;
        if(mode === '3v3' || mode === '2v2v2') pCount = 6; // NEW MODES
        
        const pEl = document.getElementById('nc-players');
        if(pEl) pEl.innerText = pCount;
    }
function setBattleType(type) { 
        AudioEngine.ui(); 
        battleType = type; 
        
        // Toggle Active Cards
        document.getElementById('card-std').classList.toggle('active', type === 'standard'); 
        document.getElementById('card-jack').classList.toggle('active', type === 'jackpot');
        document.getElementById('card-point').classList.toggle('active', type === 'point'); // NEW
        
        // Update Text Description
        const desc = document.getElementById('mode-desc');
        if(desc) {
            if(type === 'standard') desc.innerText = "Classic: The player with the highest TOTAL VALUE wins the entire battle.";
            else if(type === 'jackpot') desc.innerText = "Jackpot: The winner is determined by a weighted spin based on total value.";
            else if(type === 'point') desc.innerText = "Point Rush: The player who wins the most individual rounds wins the battle.";
        }
    }

// --- UPDATED BATTLE LOGIC (PackDraw Style) ---

		async function startBattle() {
        if(!UserSystem.checkLogin()) return;
        const cost = battleQueue.reduce((a,b) => a + b.cost, 0);
        if(cost === 0) return;
        if(balance < cost) { alert("Not enough coins!"); return; }
        
        // --- PARTICIPANT GENERATION ---
        let participants = [];
        if (battleMode === '1v1') {
            participants = [{id:'p',name:UserSystem.username,team:0, avatar:''}, {id:'b1',name:'Bot 1',team:1, avatar:''}];
        } else if (battleMode === '1v1v1') {
            participants = [{id:'p',name:UserSystem.username,team:0, avatar:''}, {id:'b1',name:'Bot 1',team:1, avatar:''}, {id:'b2',name:'Bot 2',team:2, avatar:''}];
        } else if (battleMode === '1v1v1v1') {
            participants = [{id:'p',name:UserSystem.username,team:0, avatar:''}, {id:'b1',name:'Bot 1',team:1, avatar:''}, {id:'b2',name:'Bot 2',team:2, avatar:''}, {id:'b3',name:'Bot 3',team:3, avatar:''}];
        } else if (battleMode === '2v2') {
            participants = [{id:'p',name:UserSystem.username,team:0, avatar:''}, {id:'b1',name:'Teammate',team:0, avatar:''}, {id:'b2',name:'Enemy 1',team:1, avatar:''}, {id:'b3',name:'Enemy 2',team:1, avatar:''}];
        } 
        else if (battleMode === '3v3') {
            participants = [
                {id:'p',name:UserSystem.username,team:0, avatar:''}, {id:'b1',name:'Teammate 1',team:0, avatar:''}, {id:'b2',name:'Teammate 2',team:0, avatar:''},
                {id:'b3',name:'Enemy 1',team:1, avatar:''}, {id:'b4',name:'Enemy 2',team:1, avatar:''}, {id:'b5',name:'Enemy 3',team:1, avatar:''}
            ];
        } else if (battleMode === '2v2v2') {
            participants = [
                {id:'p',name:UserSystem.username,team:0, avatar:''}, {id:'b1',name:'Teammate',team:0, avatar:''},
                {id:'b2',name:'Enemy 1',team:1, avatar:''}, {id:'b3',name:'Enemy 2',team:1, avatar:''},
                {id:'b4',name:'Enemy 3',team:2, avatar:''}, {id:'b5',name:'Enemy 4',team:2, avatar:''}
            ];
        }

        const totalOps = battleQueue.length * participants.length;
        const pfData = await ProvablyFair.generate(totalOps, 'float');
        const randomFloats = pfData.values;

        balance -= cost; updateBalanceUI();
        AudioEngine.ui();

        document.getElementById('battle-setup').classList.add('hidden');
        document.getElementById('battle-arena').classList.remove('hidden');
        document.getElementById('jackpot-wrapper').classList.add('hidden');
        document.getElementById('btn-battle-reset').classList.add('hidden');

        const container = document.getElementById('battle-arena-container'); 
        container.innerHTML = '';
        container.classList.remove('fade-out');
        
        if (participants.length > 4) container.classList.add('six-player-mode');
        else container.classList.remove('six-player-mode');
        
        const arenaHeader = document.createElement('div');
        arenaHeader.className = 'battle-info-bar';
        arenaHeader.innerHTML = `<div class="bib-stat">Round <span class="bib-highlight" id="battle-round-counter">1 / ${battleQueue.length}</span></div><div class="bib-stat"><span class="bib-highlight" id="battle-case-name">Loading...</span></div><div class="bib-stat">Cost <span class="bib-highlight">$${cost.toFixed(2)}</span></div>`;
        const oldHeader = document.querySelector('.battle-info-bar');
        if(oldHeader) oldHeader.remove();
        document.getElementById('battle-arena').insertBefore(arenaHeader, container);

        participants.forEach((part, index) => {
            const col = document.createElement('div'); 
            col.className = 'battle-column'; 
            col.id = `col-${part.id}`;
            
            // --- FIX: DETERMINE INITIAL TEXT BASED ON MODE ---
            let initText = '$0.00';
            let initColor = ''; 
            
            if (battleType === 'jackpot') { initText = '0.0%'; initColor = '#fff'; }
            else if (battleType === 'point') { initText = '0'; initColor = '#00bcd4'; }
            
            col.innerHTML = `
                <div class="battle-user-card">
                    <div class="buc-avatar">${part.avatar}</div>
                    <div class="buc-name">${part.name}</div>
                    <div class="buc-total" id="score-${part.id}" data-val="0" data-points="0" style="color:${initColor}">${initText}</div>
                    <div id="sub-${part.id}" style="font-size:0.75rem; color:#8a9bb0; margin-top:4px; font-weight:bold;">0%</div>
                </div>
                <div class="battle-reel-wrapper" id="reel-container-${part.id}"></div>
                <div class="battle-history" id="history-${part.id}"></div>
            `;
            container.appendChild(col);

            // VS DIVIDERS
            if(battleMode === '1v1' && index === 0) addVs(container);
            if(battleMode === '2v2' && index === 1) addVs(container);
            if(battleMode === '3v3' && index === 2) addVs(container);
            if(battleMode === '2v2v2' && (index === 1 || index === 3)) addVs(container);
        });

        let results = {};
        let floatIdx = 0;
        participants.forEach(part => {
            results[part.id] = [];
            battleQueue.forEach(c => { results[part.id].push(getCaseResult(c, randomFloats[floatIdx++])); });
        });

        const pfLogData = { result: "See Rounds", ...pfData, battleDetails: { participants, rounds: battleQueue.length } }; 
        processBattleRound(0, participants, results, cost, pfLogData);
    }

    // Helper for dividers
    function addVs(container) {
        const vs = document.createElement('div'); 
        vs.className = 'vs-divider'; 
        vs.innerText = 'VS'; 
        container.appendChild(vs);
    }
  
  
    function getCaseResult(c, randFloat) {
        let cumulative = 0;
        for (let item of c.items) { 
            cumulative += item.chance; 
            if (randFloat < cumulative) return item; 
        }
        return c.items[0];
    }
		function processBattleRound(roundIndex, participants, results, totalCost, pfLogData) {
        // --- 1. CHECK END OF BATTLE ---
        if(roundIndex >= battleQueue.length) { 
            let finalScores = {};
            let grandTotal = 0;
            let finalPoints = {};

            participants.forEach(p => {
                const scoreEl = document.getElementById(`score-${p.id}`);
                const val = parseFloat(scoreEl.getAttribute('data-val')) || 0;
                const pts = parseInt(scoreEl.getAttribute('data-points')) || 0;
                finalScores[p.id] = val;
                finalPoints[p.id] = pts;
                grandTotal += val;
            });

            if(battleType === 'jackpot') startJackpotSpin(participants, totalCost, pfLogData, finalScores, grandTotal);
            else if(battleType === 'point') finishBattlePoint(participants, totalCost, pfLogData, finalPoints, grandTotal);
            else finishBattleStandard(participants, totalCost, pfLogData, finalScores, grandTotal);
            return; 
        }
        
        const caseData = battleQueue[roundIndex];
        const boxCost = caseData.cost; 

        // Update Header
        document.getElementById('battle-round-counter').innerText = `${roundIndex+1} / ${battleQueue.length}`;
        document.getElementById('battle-case-name').innerText = caseData.name;
        const ind = document.getElementById('battle-round-indicator');
        if(ind) ind.innerText = ''; 

        // Config
        const ITEM_HEIGHT = 110; 
        const VIEWPORT_HEIGHT = 320; 
        const WINNING_INDEX = 50; 

        // --- 2. RENDER REELS ---
        participants.forEach(part => {
            const result = results[part.id][roundIndex];
            const cont = document.getElementById(`reel-container-${part.id}`);
            cont.innerHTML = '';
            
            const vp = document.createElement('div'); 
            vp.className = 'viewport-vertical'; 
            vp.style.height = VIEWPORT_HEIGHT + "px"; 
            vp.style.width = "100%"; 
            vp.style.border = "none";
            
            const reel = document.createElement('div'); 
            reel.className = 'reel-vertical'; 
            reel.id = `inner-reel-${part.id}`;
            
            for(let i=0; i<70; i++) {
                let item = (i === WINNING_INDEX) ? result : caseData.items[Math.floor(Math.random() * caseData.items.length)];
                const rarity = getRarityClass(item.value, boxCost);
                
                const el = document.createElement('div'); 
                el.className = `item-vertical ${rarity}`;
                el.style.cssText = `height:${ITEM_HEIGHT}px; background:transparent !important; border:none !important; box-shadow:none !important;`;
                
                el.innerHTML = `
                    <img src="${item.icon}" class="skin-img" style="height:80px; width:auto;">
                    <div class="spinner-text-v" style="text-align:center; margin-top:4px; line-height:1.2;">
                        <div style="font-size:0.75rem; font-weight:bold; color:#fff;">${item.name}</div>
                        <div style="font-size:0.75rem; font-weight:bold;">$${item.value.toFixed(2)}</div>
                    </div>
                `;
                reel.appendChild(el);
            }
            
            vp.innerHTML = `<div class="center-highlight"></div><div class="payline-indicator" style="left:2px; border-left:8px solid #fff;"></div><div class="payline-indicator" style="right:2px; border-right:8px solid #fff;"></div>`;
            vp.appendChild(reel); 
            cont.appendChild(vp);
        });

        // --- 3. TRIGGER ANIMATION ---
        setTimeout(() => {
            participants.forEach(part => {
                const reelEl = document.getElementById(`inner-reel-${part.id}`);
                if(reelEl) {
                    const centerPos = -(WINNING_INDEX * ITEM_HEIGHT) + (VIEWPORT_HEIGHT / 2) - (ITEM_HEIGHT / 2);
                    reelEl.style.transition = `transform 5500ms cubic-bezier(0.1, 0, 0.15, 1)`; 
                    reelEl.style.transform = `translateY(${centerPos}px)`;
                }
            });
            
            let lastIdx = -1; 
            const startTime = performance.now(); 
            const pReel = document.getElementById(`inner-reel-${participants[0].id}`);
            
            function checkTick(now) {
                if(!pReel) return;
                let matrix; try { const style = window.getComputedStyle(pReel); if(window.WebKitCSSMatrix) matrix = new WebKitCSSMatrix(style.transform); else if(window.DOMMatrix) matrix = new DOMMatrix(style.transform); } catch(e) { return; } 
                if(matrix) { const val = Math.abs(matrix.m42); const curIdx = Math.floor((val + (VIEWPORT_HEIGHT/2)) / ITEM_HEIGHT); if (curIdx !== lastIdx) { if(now - startTime < 5000) AudioEngine.tick(); lastIdx = curIdx; } }
                if (now - startTime < 5500) requestAnimationFrame(checkTick);
            }
            requestAnimationFrame(checkTick);
        }, 100);

        // --- 4. LAND & CALCULATE ---
        setTimeout(() => {
            let currentGrandTotal = 0;
            let playerNewTotals = {};
            let roundTeamTotals = {}; 

            participants.forEach(part => {
                const reelEl = document.getElementById(`inner-reel-${part.id}`);
                if(reelEl && reelEl.children[WINNING_INDEX]) reelEl.children[WINNING_INDEX].classList.add('winner-landed');

                const res = results[part.id][roundIndex];
                
                roundTeamTotals[part.team] = (roundTeamTotals[part.team] || 0) + res.value;

                let scoreEl = document.getElementById(`score-${part.id}`);
                let currentVal = parseFloat(scoreEl.getAttribute('data-val')) || 0;
                let newVal = currentVal + res.value;
                scoreEl.setAttribute('data-val', newVal); 
                playerNewTotals[part.id] = newVal;
                currentGrandTotal += newVal;

                const historyCont = document.getElementById(`history-${part.id}`);
                const histItem = document.createElement('div');
                histItem.className = 'history-item ' + getRarityClass(res.value, boxCost);
                histItem.innerHTML = `<img src="${res.icon}"><div class="history-item-name">${res.name}</div><div class="history-item-price">$${res.value.toFixed(2)}</div>`;
                historyCont.prepend(histItem);
            });

            // --- FIX: DETERMINE TIE / MULTI-WINNERS ---
            let winningTeams = [];
            let bestScore = isCrazyMode ? Infinity : -1;

            // 1. Find the Best Score (Highest or Lowest)
            for(const [team, val] of Object.entries(roundTeamTotals)) {
                if (isCrazyMode) {
                    if (val < bestScore) bestScore = val;
                } else {
                    if (val > bestScore) bestScore = val;
                }
            }

            // 2. Add ALL teams that match that score to the winners list
            for(const [team, val] of Object.entries(roundTeamTotals)) {
                if (val === bestScore) {
                    winningTeams.push(team); // '0', '1', etc.
                }
            }

            // 3. Assign Points & Update UI
            participants.forEach(part => {
                const scoreEl = document.getElementById(`score-${part.id}`);
                const subEl = document.getElementById(`sub-${part.id}`);
                
                let currentPts = parseInt(scoreEl.getAttribute('data-points')) || 0;
                
                // Check if this player's team is in the winning list
                if (winningTeams.includes(String(part.team))) {
                    currentPts += 1;
                    scoreEl.setAttribute('data-points', currentPts);
                    
                    if(battleType === 'point') {
                        scoreEl.style.transform = "scale(1.3)";
                        scoreEl.style.color = "#fff";
                        setTimeout(() => { scoreEl.style.transform = "scale(1)"; scoreEl.style.color = "#00bcd4"; }, 400);
                    }
                }

                const myTotal = playerNewTotals[part.id];
                let pct = (currentGrandTotal === 0) ? 0 : (myTotal / currentGrandTotal) * 100;

                if (battleType === 'jackpot') {
                    scoreEl.innerText = pct.toFixed(1) + '%';
                    scoreEl.style.color = '#fff';
                    subEl.innerText = '$' + myTotal.toFixed(2);
                    subEl.style.color = '#00e701';
                } 
                else if (battleType === 'point') {
                    scoreEl.innerText = currentPts;
                    scoreEl.style.color = '#00bcd4';
                    subEl.innerText = '$' + myTotal.toFixed(2);
                    subEl.style.color = '#00e701';
                }
                else {
                    scoreEl.innerText = '$' + myTotal.toFixed(2);
                    scoreEl.style.color = '#00e701'; 
                    subEl.innerText = pct.toFixed(1) + '%';
                }
            });

            if(battleType === 'jackpot') updateWinChances(participants);
            
            setTimeout(() => processBattleRound(roundIndex + 1, participants, results, totalCost, pfLogData), 2500);
            
        }, 5500);
    }

		function updateWinChances(participants) {
        let totalVal = 0;
        let scores = {};

        // 1. Gather all scores first
        participants.forEach(p => {
            const scoreEl = document.getElementById(`score-${p.id}`);
            const val = parseFloat(scoreEl.getAttribute('data-val')) || 0;
            scores[p.id] = val;
            totalVal += val;
        });
        
        // 2. Calculate Inverse Sum for Crazy Mode
        let inverseSum = 0;
        if (isCrazyMode) {
            participants.forEach(p => { 
                let s = scores[p.id];
                // Treat 0 as 0.01 so it has a massive weight (winning) instead of 0 weight
                let eff = s <= 0 ? 0.01 : s; 
                inverseSum += (1 / eff); 
            });
        }

        // 3. Calculate and Update Percentages
        participants.forEach(p => {
            let chance = 0;
            
            if (isCrazyMode) {
                // CRAZY MODE: Inverse Weights
                let s = scores[p.id];
                let eff = s <= 0 ? 0.01 : s; // Prevent divide by zero
                
                if (inverseSum > 0) {
                    chance = ((1 / eff) / inverseSum) * 100;
                }
            } else {
                // NORMAL MODE: Standard Weights
                chance = (totalVal === 0) ? 0 : ((scores[p.id] / totalVal) * 100);
            }
            
            // Update UI
            const el = document.getElementById(`pct-${p.id}`);
            if(el) el.innerText = chance.toFixed(1) + "%";
        });
    }

		function startJackpotSpin(participants, totalCost, pfLogData, finalScores, grandTotal) {
        const wrapper = document.getElementById('jackpot-wrapper');
        wrapper.classList.remove('hidden');
        wrapper.classList.remove('pointer-hidden');

        const oldOverlay = wrapper.querySelector('.jackpot-winner-overlay');
        if(oldOverlay) oldOverlay.remove();
        
        if (grandTotal === 0) { 
            finalizeBattle(-1, true, 0, totalCost, participants, pfLogData); 
            wrapper.classList.add('hidden');
            return; 
        }

        // --- 1. CALCULATE WEIGHTS (Normal vs Crazy) ---
        let pool = [];
        let inverseSum = 0;
        
        // If Crazy Mode, we need the sum of (1/Score) for everyone
        if (isCrazyMode) {
            participants.forEach(p => { 
                let s = finalScores[p.id];
                let eff = s <= 0 ? 0.01 : s; // Prevent divide by zero
                inverseSum += (1 / eff); 
            });
        }

        participants.forEach(part => {
            let score = finalScores[part.id] || 0;
            let weight = 0;

            if (isCrazyMode) {
                // REVERSE JACKPOT: Lower score = Higher weight
                let eff = score <= 0 ? 0.01 : score;
                if(inverseSum > 0) {
                    weight = ((1 / eff) / inverseSum) * grandTotal; 
                }
            } else {
                // NORMAL JACKPOT: Higher score = Higher weight
                weight = score;
            }

            pool.push({ 
                id: part.id, 
                team: part.team, 
                score: score, 
                weight: weight, // Virtual weight for the wheel
                color: PLAYER_COLORS[part.id], 
                name: part.name, 
                avatar: part.avatar 
            });
        });

        // --- 2. SPIN LOGIC ---
        // We spin based on 'weight' (which equals score in Normal mode, or inverse score in Crazy mode)
        let rand = Math.random() * grandTotal;
        let winnerObj = null; 
        let runningTotal = 0;
        
        for(let p of pool) { 
            runningTotal += p.weight; 
            if (rand <= runningTotal) { winnerObj = p; break; } 
        }
        if(!winnerObj) winnerObj = pool[pool.length-1];
        
        // --- 3. RENDER WHEEL ---
        const reel = document.getElementById('jackpot-reel');
        reel.innerHTML = ''; reel.style.transition = 'none'; reel.style.transform = 'translateX(0px)';
        const BAR_WIDTH = 600; const REPEATS = 30;
        
        for(let i=0; i<REPEATS; i++) {
            pool.forEach(p => {
                // Bar width depends on Weight (Odds), not just raw Score
                let width = (p.weight / grandTotal) * BAR_WIDTH;
                if(width < 3) width = 3; 
                const el = document.createElement('div'); el.className = 'jackpot-bar';
                el.style.width = width + "px"; el.style.backgroundColor = p.color;
                if (width > 35) el.innerHTML = `<div class="jackpot-bar-pfp">${p.avatar}</div>`;
                reel.appendChild(el);
            });
        }

        const targetIteration = REPEATS - 5; 
        // Important: Location must align with the "weighted" random value
        const locationInBar = (rand / grandTotal) * BAR_WIDTH;
        
        setTimeout(() => {
            const viewportEl = document.querySelector('#jackpot-window .viewport-horizontal');
            const viewportW = viewportEl ? viewportEl.offsetWidth : 600;
            
            const targetX = -((targetIteration * BAR_WIDTH) + locationInBar - (viewportW / 2));
            reel.style.transition = `transform 3000ms cubic-bezier(0.1, 0, 0.1, 1)`;
            reel.style.transform = `translateX(${targetX}px)`;
        }, 50);

        setTimeout(() => {
            AudioEngine.win();
            wrapper.classList.add('pointer-hidden');

            const overlay = document.createElement('div');
            overlay.className = 'jackpot-winner-overlay';
            const isTeamMode = ['2v2', '3v3', '2v2v2'].includes(battleMode);
            const userIsWinner = (winnerObj.team === 0);
            
            let winTitle = "Jackpot Winner";
            if (isTeamMode && userIsWinner) winTitle = "Your Team Won!";
            
            // Calculate chance based on the WEIGHT
            let winChance = (winnerObj.weight / grandTotal) * 100;

            overlay.innerHTML = `
                <div class="jwo-title">${winTitle}</div>
                <div class="jwo-avatar">${winnerObj.avatar}</div>
                <div class="jwo-name" style="color:${winnerObj.color}">${winnerObj.name}</div>
                <div class="jwo-amount">${winChance.toFixed(2)}%</div>
            `;
            wrapper.appendChild(overlay);
            requestAnimationFrame(() => overlay.classList.add('jwo-visible'));
            
            setTimeout(() => {
                 wrapper.classList.add('hidden');
                 overlay.remove();
                 finalizeBattle(winnerObj.team, false, grandTotal, totalCost, participants, pfLogData);
            }, 1500); 
        }, 3500); 
    }

		function renderEndScreen(winningTeam, participants, grandTotal) {
        // 1. Determine Winning Participants
        const winners = participants.filter(p => p.team == winningTeam);
        
        // 2. Determine Text (Team vs Solo)
        const userWon = winners.some(p => p.id === 'p'); 
        const isTeamMode = ['2v2', '3v3', '2v2v2'].includes(battleMode);
        
        let headerText = "Battle Completed";
        if(userWon) {
            headerText = isTeamMode ? "YOUR TEAM WON!" : "YOU WON!";
            AudioEngine.win();
        } else {
            headerText = "YOU LOST";
            AudioEngine.lose();
        }

        // 3. Calculate Split Payout
        // Example: If Pot is $100 and it's a 2v2, payout is $50 each.
        const payoutPerPerson = grandTotal / winners.length;

        // 4. Build HTML
        const container = document.getElementById('battle-arena');
        const old = document.querySelector('.battle-results-overlay');
        if(old) old.remove();

        const overlay = document.createElement('div');
        overlay.className = 'battle-results-overlay';
        
        let winnersHtml = '';
        winners.forEach(w => {
            // FIX: Display the PAYOUT (Shared Pot), not the unboxed score
            winnersHtml += `
                <div class="bro-winner-card">
                    <div class="bro-crown"></div>
                    <div class="bro-avatar" style="border-color:${PLAYER_COLORS[w.id]}">${w.avatar}</div>
                    <div class="bro-name">${w.name}</div>
                    <div class="bro-amount" style="color:#00e701; text-shadow:0 0 10px rgba(0,231,1,0.4);">
                        +$${payoutPerPerson.toFixed(2)}
                    </div>
                </div>
            `;
        });

        const cost = battleQueue.reduce((a,b) => a + b.cost, 0);

        overlay.innerHTML = `
            <div class="bro-header" style="color: ${userWon ? '#00e701' : '#e94560'}">${headerText}</div>
            <div class="bro-winners-row">
                ${winnersHtml}
            </div>
            <div style="color:#6e7a8e; margin-bottom:20px; font-weight:bold;">
                Total Pot: <span style="color:#fff;">$${grandTotal.toFixed(2)}</span>
            </div>
            <div class="bro-actions">
                <button class="bro-btn bro-replay" onclick="replayBattle()">Recreate ($${cost.toFixed(2)})</button>
                <button class="bro-btn bro-new" onclick="resetBattleUI()">New Battle</button>
            </div>
        `;

        container.appendChild(overlay);
        requestAnimationFrame(() => overlay.classList.add('bro-visible'));
    }

    // Helper for Replay Button
    function replayBattle() {
        resetBattleUI();
        startBattle(); // queues are still preserved
    }

function finalizeBattle(winningTeam, isDraw, grandTotal, cost, participants, pfLogData) {
        if (isDraw) { 
            balance += cost; 
            // FIX: Added 'cost' as the missing wager argument
            logGame('Box Battle', 'Draw', 0, cost, pfLogData);
            alert("Draw! Refunded.");
        } else {
            const user = participants.find(p => p.id === 'p');
            const userWon = (user.team == winningTeam);
            
            if (userWon) {
                const winnersCount = participants.filter(p => p.team == winningTeam).length;
                
                // PAYOUT LOGIC: Total Pot divided by Team Size
                const myShare = grandTotal / winnersCount;
                
                balance += myShare; 
                
                logGame('Box Battle', 'Win', myShare - cost, cost, pfLogData);
            } else {
                // FIX: Removed 'myShare' (which caused the crash) and set to 'Loss'
                logGame('Box Battle', 'Loss', -cost, cost, pfLogData);
            }
        }
        
        updateBalanceUI(); 
        trackHistory();
        UserSystem.save();
        
        if(!isDraw) renderEndScreen(winningTeam, participants, grandTotal);
        else resetBattleUI();
    }
    
		function resetBattleUI() {
        // 1. Hide Arena & Show Setup
        document.getElementById('battle-arena').classList.add('hidden');
        document.getElementById('battle-setup').classList.remove('hidden');
        
        // 2. Clear Old Text/Styles
        const resText = document.getElementById('battle-result-text');
        if(resText) resText.innerText = '';
        
        document.querySelectorAll('.battle-column').forEach(c => c.classList.remove('winner-glow', 'loser-dim'));
        
        // 3. Clear Jackpot Elements
        document.getElementById('jackpot-wrapper').classList.add('hidden');
        document.getElementById('jackpot-reel').innerHTML = '';
        const announce = document.getElementById('winner-announcement');
        if(announce) announce.innerText = '';
        
        // 4. Reset Fade Animations
        document.getElementById('battle-arena-container').classList.remove('fade-out');

        // --- THE FIX: REMOVE THE END SCREEN OVERLAY ---
        const overlay = document.querySelector('.battle-results-overlay');
        if(overlay) overlay.remove();
    }
    // --- OTHER NAVIGATION & FUNDS ---
    function switchScreen(name) {
        AudioEngine.ui();
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        
        if (name === 'history') {
            openHistory();
            document.getElementById('home-screen').classList.remove('hidden'); 
            return; 
        }

        const screenId = name + '-screen'; const screen = document.getElementById(screenId);
        if(screen) {
            screen.classList.remove('hidden');
            if(name === 'stats') renderChart();
            if(name === 'cases') renderCaseList(); 
            if(name === 'battle') { updateBattleQueueUI(); } 
            if(name === 'game') updateDiceCalculations();
        }
    }
    
    function openHistory() {
        AudioEngine.ui();
        renderHistory();
        document.getElementById('history-modal').classList.remove('hidden');
    }

    function openFundsModal() { AudioEngine.ui(); document.getElementById('funds-modal').classList.remove('hidden'); }
    function submitFunds() {
        AudioEngine.chip();
        const amt = parseFloat(document.getElementById('deposit-amount').value);
        if(isNaN(amt) || amt <= 0) return alert("Invalid amount");
        balance += amt; updateBalanceUI(); UserSystem.save(); document.getElementById('funds-modal').classList.add('hidden');
    }
    function updateBalanceUI() { document.getElementById('global-balance').innerText = balance.toFixed(2); }
    function trackHistory() { balanceHistory.push(balance); turnLabels.push("Turn " + (balanceHistory.length - 1)); }
    
// Updated logGame to accept Wager
    function logGame(gameName, result, profit, wager, pfData = null) {
        // 1. Update History
        const entry = { 
            game: gameName, 
            result: result, 
            amount: profit, 
            date: new Date().toLocaleTimeString(),
            pfData: pfData 
        };
        gameHistory.unshift(entry); 
        if(gameHistory.length > 50) gameHistory.pop();
        UserSystem.save();

        // 2. Update Live Stats
        // Determine if it was a win based on profit >= 0
        // (Note: In some games like blackjack push, profit is 0, we count as win/neutral)
        const isWin = profit >= 0; 
        LiveStats.update(profit, wager, isWin);
    }

    function renderHistory() {
        const tbody = document.getElementById('history-body'); tbody.innerHTML = '';
        const filter = document.getElementById('history-filter').value;

        if(gameHistory.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No games played yet.</td></tr>'; return; }
        
        gameHistory.forEach((g, index) => {
            if (filter !== 'All' && g.game !== filter) return;

            const tr = document.createElement('tr');
            let amtClass = g.amount >= 0 ? 'win-text' : 'lose-text';
            let amtSign = g.amount >= 0 ? '+' : '';
            
            let verifyHtml = '-';
            if(g.pfData) {
                verifyHtml = `<button class="verify-btn" onclick="verifyGame(${index})">Verify</button>`;
            }

            tr.innerHTML = `<td>${g.game}</td><td>${g.result}</td><td class="${amtClass}">${amtSign}$${g.amount.toFixed(2)}</td><td>${verifyHtml}</td><td style="color:#777">${g.date}</td>`;
            tbody.appendChild(tr);
        });
    }

    function verifyGame(index) {
        AudioEngine.ui();
        currentVerifyIndex = index;
        const g = gameHistory[index];
        if(!g || !g.pfData) return;
        
        document.getElementById('verify-game-name').innerText = g.game;
        
        let resText = "";
        
        if(g.game === 'Dice') {
            resText = `Roll: ${g.pfData.values ? g.pfData.values[0].toFixed(2) : g.result}`;
        }
        else if(g.game === 'Blackjack') {
            resText = `Deck Shuffled (Hash Seed: ${g.pfData.seedHash ? g.pfData.seedHash.substring(0,8) : '...'})`;
        }
        else if(g.game === 'Cases') {
            resText = `Tickets Generated: \n` + g.pfData.values.map((v, i) => `Item ${i+1}: ${(v*100).toFixed(6)}%`).join('\n');
        }
        else if(g.game === 'Box Battle') {
            const vals = g.pfData.values;
            const parts = g.pfData.battleDetails.participants;
            const rounds = g.pfData.battleDetails.rounds;
            let output = "";
            let vIdx = 0;
            parts.forEach(p => {
                output += `\n[${p.name}]:\n`;
                for(let r=0; r<rounds; r++) {
                    if(vIdx < vals.length) {
                        output += `  Round ${r+1}: Ticket ${(vals[vIdx]*100).toFixed(6)}%\n`;
                        vIdx++;
                    }
                }
            });
            resText = output;
        }
        
        document.getElementById('verify-result').innerText = resText;
        document.getElementById('verify-client').innerText = g.pfData.clientSeed;
        document.getElementById('verify-nonce').innerText = g.pfData.nonce;
        
        const isActive = (g.pfData.serverSeed === ProvablyFair.serverSeed);
        const serverEl = document.getElementById('verify-server');
        const warnEl = document.getElementById('verify-warning');
        
        if(isActive) {
            serverEl.innerHTML = `<span class="blur">Hidden (Active)</span> <button class="rotate-btn-small" onclick="ProvablyFair.rotateSeed()">Rotate to View</button>`;
            warnEl.style.display = 'block';
        } else {
            serverEl.innerText = g.pfData.serverSeed;
            warnEl.style.display = 'none';
        }
        
        document.getElementById('verify-modal').classList.remove('hidden');
    }

    function renderChart() {
        const ctx = document.getElementById('profitChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line', data: { labels: turnLabels, datasets: [{ label: 'Balance', data: balanceHistory, borderColor: '#e94560', backgroundColor: 'rgba(233,69,96,0.2)', fill: true, tension: 0.3 }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#a0a0a0' }, grid: { color: '#2a2a40' } }, x: { display: false } } }
        });
    }

    // --- CASE OPENER LOGIC ---
    let currentCase = null; let openCount = 1;
    function renderCaseList() {
        const listContainer = document.getElementById('cases-list'); listContainer.innerHTML = '';
        casesDB.forEach(c => {
            const el = document.createElement('div'); el.className = 'game-card'; el.style.padding = '10px'; el.style.aspectRatio = 'unset';
            el.onclick = () => selectCase(c.id);
            el.innerHTML = `<img src="${c.image}" style="width:100px; height:auto; margin-bottom:10px;"><div>${c.name}</div><div style="color:#e94560; font-weight:bold">$${c.cost.toFixed(2)}</div>`;
            listContainer.appendChild(el);
        });
    }
		function selectCase(id) {
        AudioEngine.ui();
        currentCase = casesDB[id];
        document.getElementById('cases-list').classList.add('hidden');
        document.getElementById('case-opener').classList.remove('hidden');
        document.getElementById('case-title').innerText = currentCase.name;
        setOpenCount(1);
        
        const listDiv = document.getElementById('case-contents-display'); 
        listDiv.innerHTML = '';
        
        // Render the Pro Cards
        currentCase.items.forEach(item => {
            const rarity = getRarityClass(item.value, currentCase.cost);
            // Format percentage cleanly (e.g. 0.05 -> 5%)
            const pctVal = item.chance * 100;
            // If it's a tiny chance (like 0.002), show more decimals
            const pctStr = pctVal < 0.1 ? pctVal.toFixed(3) : (pctVal < 1 ? pctVal.toFixed(2) : pctVal.toFixed(0));
            
            const card = document.createElement('div'); 
            card.className = `item-card ${rarity}`;
            
            card.innerHTML = `
                <img src="${item.icon}">
                <div class="item-name">${item.name}</div>
                <div class="item-meta">
                    <span class="item-price">$${item.value.toFixed(2)}</span>
                    <span class="item-chance">${pctStr}%</span>
                </div>
            `;
            listDiv.appendChild(card);
        });
        fillSpinnerRandomly();
    }
    
		function fillSpinnerRandomly() {
        const area = document.getElementById('spinner-area');
        area.innerHTML = '';
        
        // Generate random items for visual preview
        const randomItems = [];
        for(let i=0; i<40; i++) randomItems.push(currentCase.items[Math.floor(Math.random() * currentCase.items.length)]);

        if(openCount === 1) { 
            const vp = document.createElement('div'); vp.className = 'viewport-horizontal';
            const reel = document.createElement('div'); reel.className='reel-horizontal';
            vp.innerHTML = `<div class="pointer-horizontal"></div>`;
            
            randomItems.forEach(item => {
                const r = getRarityClass(item.value, currentCase.cost);
                const el = document.createElement('div'); 
                el.className = `item-horizontal ${r}`;
                el.innerHTML = `<img src="${item.icon}"><div class="spinner-text-h">$${item.value.toFixed(2)}</div>`;
                reel.appendChild(el);
            });
            
            // Center the reel initially
            reel.style.transform = 'translateX(-600px)'; 
            vp.appendChild(reel); area.appendChild(vp);
        } else {
            // Multi-spin Vertical
            for(let i=0; i<openCount; i++) {
                const vp = document.createElement('div'); vp.className = 'viewport-vertical';
                const reel = document.createElement('div'); reel.className='reel-vertical';
                vp.innerHTML = `<div class="pointer-vertical"></div>`;
                
                randomItems.forEach(item => {
                    const r = getRarityClass(item.value, currentCase.cost);
                    const el = document.createElement('div'); el.className = `item-vertical ${r}`;
                    el.innerHTML = `<img src="${item.icon}"><div class="spinner-text-v" style="margin-top:0;"><div>${item.name}</div><div>$${item.value.toFixed(2)}</div></div>`;
                    reel.appendChild(el);
                });
                
                reel.style.transform = 'translateY(-600px)';
                vp.appendChild(reel); area.appendChild(vp);
            }
        }
    }

    function setOpenCount(n) {
        AudioEngine.ui();
        openCount = n;
        document.querySelectorAll('#case-opener .multi-btn').forEach((btn, i) => { if(i + 1 === n) btn.classList.add('active'); else btn.classList.remove('active'); });
        document.getElementById('case-cost').innerText = `Cost: $${(currentCase.cost * openCount).toFixed(2)}`;
        fillSpinnerRandomly(); 
    }

    function renderSpinners() {
        const area = document.getElementById('spinner-area'); area.innerHTML = ''; document.getElementById('case-result-text').innerText = "";
        if(openCount === 1) { area.innerHTML = `<div class="viewport-horizontal"><div class="pointer-horizontal"></div><div id="reel-0" class="reel-horizontal"></div></div>`; } 
        else { for(let i=0; i<openCount; i++) { const vp = document.createElement('div'); vp.className = 'viewport-vertical'; vp.innerHTML = `<div class="pointer-vertical"></div><div id="reel-${i}" class="reel-vertical"></div>`; area.appendChild(vp); } }
    }

		async function triggerOpenCase() {
        if(!UserSystem.checkLogin()) return;
        const totalCost = currentCase.cost * openCount;
        if (balance < totalCost) { alert("Not enough coins!"); return; }
        
        // 1. Generate Result
        const pfData = await ProvablyFair.generate(openCount, 'float');
        const pfFloats = pfData.values;
        
        balance -= totalCost; updateBalanceUI();
        AudioEngine.ui();
        
        renderSpinners(); // Reset DOM

        const btn = document.getElementById('btn-open-case'); btn.disabled = true;
        document.getElementById('case-result-text').innerText = "Spinning...";
        
        const results = []; 
        for(let c=0; c<openCount; c++) results.push(getCaseResult(currentCase, pfFloats[c]));
        
        // --- ANIMATION CONFIG ---
        const SPIN_DURATION = 6000; // 6 seconds for suspense
        const WIN_INDEX = 45; // Land on 45th item
        const ITEM_WIDTH = 140; // Matches CSS min-width
        const ITEM_HEIGHT = 120; // For vertical mode
        
        results.forEach((wonItem, index) => {
            const reel = document.getElementById(`reel-${index}`);
            reel.innerHTML = ''; reel.style.transition = 'none';
            reel.style.transform = openCount === 1 ? 'translateX(0px)' : 'translateY(0px)';
            
            // 2. Build Reel (Winner at Index 45)
            for (let i = 0; i < 60; i++) {
                let itemData = (i === WIN_INDEX) ? wonItem : currentCase.items[Math.floor(Math.random() * currentCase.items.length)];
                const rarity = getRarityClass(itemData.value, currentCase.cost);
                
                const el = document.createElement('div');
                if(openCount === 1) { 
                    // Horizontal
                    el.className = `item-horizontal ${rarity}`; 
                    el.innerHTML = `<img src="${itemData.icon}"><div class="spinner-text-h">$${itemData.value.toFixed(2)}</div>`; 
                } else { 
                    // Vertical
                    el.className = `item-vertical ${rarity}`; 
                    el.innerHTML = `<img src="${itemData.icon}"><div class="spinner-text-v" style="margin-top:0;"><div>${itemData.name}</div><div>$${itemData.value.toFixed(2)}</div></div>`; 
                }
                reel.appendChild(el);
            }

            // 3. Trigger Spin (Force Reflow)
            reel.offsetHeight; 
            
            // Add Motion Blur
            reel.classList.add('blur-effect');
            
            // Calculate Landing Position (Center of Viewport)
            if(openCount === 1) {
                // Horizontal Math
                const viewportW = reel.parentElement.offsetWidth;
                // Random jitter within the winning card (+/- 40px) so it's not always dead center
                const jitter = (Math.floor(Math.random() * 60) - 30);
                const targetX = -((WIN_INDEX * ITEM_WIDTH) - (viewportW / 2) + (ITEM_WIDTH / 2) + jitter);
                
                reel.style.transition = `transform ${SPIN_DURATION}ms cubic-bezier(0.15, 0, 0.10, 1)`; 
                reel.style.transform = `translateX(${targetX}px)`;
            } else {
                // Vertical Math
                const targetY = -((WIN_INDEX * ITEM_HEIGHT) - (320 / 2) + (ITEM_HEIGHT / 2)); // 320 is viewport height
                setTimeout(() => {
                    reel.style.transition = `transform ${SPIN_DURATION}ms cubic-bezier(0.15, 0, 0.10, 1)`; 
                    reel.style.transform = `translateY(${targetY}px)`;
                }, index * 100); // Stagger vertical start
            }
        });
        
        // --- 4. PRECISE SOUND TICKER ---
        const startTime = performance.now();
        const reel0 = document.getElementById('reel-0');
        let lastPos = 0;
        let blurRemoved = false;

        function trackAnimation(now) {
            const elapsed = now - startTime;
            
            // Remove blur near the end (at 85% progress)
            if (!blurRemoved && elapsed > (SPIN_DURATION - 800)) {
                document.querySelectorAll('.reel-horizontal, .reel-vertical').forEach(r => r.classList.remove('blur-effect'));
                blurRemoved = true;
            }

            if (elapsed < SPIN_DURATION) {
                // Get current transform value
                const style = window.getComputedStyle(reel0);
                const matrix = new WebKitCSSMatrix(style.transform);
                const currentPos = openCount === 1 ? Math.abs(matrix.m41) : Math.abs(matrix.m42); // X or Y
                const unitSize = openCount === 1 ? ITEM_WIDTH : ITEM_HEIGHT;

                // Did we cross an item boundary?
                // We check if the integer division of Position/Width has changed
                if (Math.floor(currentPos / unitSize) > Math.floor(lastPos / unitSize)) {
                    AudioEngine.tick(); // Play Click
                }
                
                lastPos = currentPos;
                requestAnimationFrame(trackAnimation);
            }
        }
        requestAnimationFrame(trackAnimation);

        // --- 5. FINISH ---
        setTimeout(() => {
            let totalWin = 0; 
            results.forEach((r, idx) => {
                totalWin += r.value;
                // Add Glow to Winner
                const reel = document.getElementById(`reel-${idx}`);
                if(reel && reel.children[WIN_INDEX]) {
                    reel.children[WIN_INDEX].classList.add('winner-landed');
                }
            });

            balance += totalWin; 
            const resText = document.getElementById('case-result-text');
            
            // Format result text
            if(results.length === 1) {
                resText.innerText = `${results[0].name} - $${totalWin.toFixed(2)}`;
            } else {
                resText.innerText = `Total Won: $${totalWin.toFixed(2)}`;
            }
            
            if(totalWin >= totalCost) { 
                resText.style.color = "#4caf50"; 
                AudioEngine.win(); 
                logGame('Cases', 'Win', totalWin - totalCost, totalCost, pfData); 
            } else { 
                resText.style.color = "#e94560"; 
                AudioEngine.lose(); 
                logGame('Cases', 'Win', totalWin - totalCost, totalCost, pfData);
            }
            
            updateBalanceUI(); trackHistory(); btn.disabled = false; UserSystem.save();
        }, SPIN_DURATION);
    }

    // --- BLACKJACK ENGINE ---
    const suits = ['', '', '', '']; const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    let deck = [], playerHand = [], dealerHand = [], bjWager = 0; let bjState = 'betting'; let bjPfData = null;
    function adjustBjBet(mult) { let val = parseFloat(document.getElementById('bj-wager').value); val = val * mult; if(val < 1) val = 1; document.getElementById('bj-wager').value = val.toFixed(2); }
    
    async function createDeck() { 
        deck = []; 
        for(let i=0; i<6; i++) { for (let s of suits) { for (let v of values) { let weight = parseInt(v); if (['J','Q','K'].includes(v)) weight = 10; if (v === 'A') weight = 11; deck.push({ value: v, suit: s, weight: weight }); } } } 
        // PF Shuffle
        const result = await ProvablyFair.generateDeckShuffle(deck);
        deck = result.deck;
        return result;
    }
    
    function drawCard() { return deck.pop(); }
    function getHandScore(hand) { let score = 0, aces = 0; for (let card of hand) { score += card.weight; if (card.value === 'A') aces++; } while (score > 21 && aces > 0) { score -= 10; aces--; } return score; }
    function createCardUI(card, isBack=false) {
        const el = document.createElement('div'); el.classList.add('bj-card'); el.classList.add('card-deal-anim'); 
        if (isBack) { el.classList.add('back'); return el; }
        const isRed = (card.suit === '' || card.suit === ''); el.classList.add(isRed ? 'red' : 'black');
        el.innerHTML = `<div class="val-corner">${card.value}</div><div style="font-size:2rem">${card.suit}</div>`; return el;
    }
    async function startBlackjack() {
        if(!UserSystem.checkLogin()) return;
        const input = document.getElementById('bj-wager'); bjWager = parseFloat(input.value);
        if(isNaN(bjWager) || bjWager <= 0 || bjWager > balance) { alert("Invalid Bet"); return; }
        balance -= bjWager; updateBalanceUI(); AudioEngine.chip();
        
        bjPfData = await createDeck(); 
        
        playerHand = []; dealerHand = [];
        document.getElementById('btn-bj-deal').disabled = true; document.getElementById('bj-controls').classList.remove('hidden'); document.getElementById('bj-status-msg').innerText = "Dealing...";
        document.getElementById('player-hand').innerHTML = ''; document.getElementById('dealer-hand').innerHTML = '';
        document.getElementById('player-score').innerText = ''; document.getElementById('dealer-score').innerText = '';
        setTimeout(() => { playerHand.push(drawCard()); appendCard('player-hand', playerHand[0]); }, 200);
        setTimeout(() => { dealerHand.push(drawCard()); appendCard('dealer-hand', dealerHand[0]); }, 800);
        setTimeout(() => { playerHand.push(drawCard()); appendCard('player-hand', playerHand[1]); updateScores(); }, 1400);
        setTimeout(() => { dealerHand.push(drawCard()); appendCard('dealer-hand', null, true); checkInitialState(); UserSystem.save(); }, 2000);
    }
    function appendCard(containerId, card, isBack=false) { const container = document.getElementById(containerId); container.appendChild(createCardUI(card, isBack)); if(!isBack) AudioEngine.card(); }
    function updateScores(revealDealer=false) { document.getElementById('player-score').innerText = getHandScore(playerHand); if(revealDealer) document.getElementById('dealer-score').innerText = getHandScore(dealerHand); else if(dealerHand.length > 0) document.getElementById('dealer-score').innerText = dealerHand[0].weight; }
    function revealDealerHole() { const container = document.getElementById('dealer-hand'); if(container.children.length > 1) { container.removeChild(container.lastChild); appendCard('dealer-hand', dealerHand[1]); } updateScores(true); }
    function checkInitialState() { updateScores(false); const dUp = dealerHand[0]; const pScore = getHandScore(playerHand); if(dUp.value === 'A') { document.getElementById('bj-status-msg').innerText = "Insurance?"; document.getElementById('bj-insurance-modal').classList.remove('hidden'); return; } if(dUp.weight === 10 && getHandScore(dealerHand) === 21) { revealDealerHole(); resolveRound(); return; } if(pScore === 21) { resolveRound(); return; } bjState = 'playing'; document.getElementById('bj-status-msg').innerText = "Your Turn"; }
    function handleInsurance(buy) { AudioEngine.ui(); document.getElementById('bj-insurance-modal').classList.add('hidden'); if(buy) { const cost = bjWager / 2; if(balance < cost) { alert("Insufficient funds"); } else { balance -= cost; updateBalanceUI(); if(getHandScore(dealerHand) === 21) { balance += cost * 3; updateBalanceUI(); document.getElementById('bj-status-msg').innerText = "Insurance Paid!"; setTimeout(() => { revealDealerHole(); resolveRound(); }, 1000); return; } else document.getElementById('bj-status-msg').innerText = "Nobody Home"; } } if(getHandScore(dealerHand) === 21) { revealDealerHole(); resolveRound(); } else if(getHandScore(playerHand) === 21) { resolveRound(); } else bjState = 'playing'; }
    function bjHit() { if(bjState !== 'playing') return; AudioEngine.ui(); const card = drawCard(); playerHand.push(card); appendCard('player-hand', card); updateScores(false); if(getHandScore(playerHand) > 21) resolveRound(); else if(getHandScore(playerHand) === 21) { bjState = 'dealer_turn'; bjStand(); } }
    function bjStand() { if(bjState === 'ended') return; AudioEngine.ui(); bjState = 'dealer_turn'; document.getElementById('bj-status-msg').innerText = "Dealer's Turn"; revealDealerHole(); let dScore = getHandScore(dealerHand); const loop = () => { if(dScore < 17) { setTimeout(() => { const c = drawCard(); dealerHand.push(c); appendCard('dealer-hand', c); dScore = getHandScore(dealerHand); updateScores(true); loop(); }, 800); } else { resolveRound(); } }; loop(); }
    function bjDouble() { if(bjState !== 'playing' || playerHand.length !== 2) return; if(balance < bjWager) { alert("Not enough funds"); return; } AudioEngine.chip(); balance -= bjWager; bjWager *= 2; updateBalanceUI(); const card = drawCard(); playerHand.push(card); appendCard('player-hand', card); updateScores(false); if(getHandScore(playerHand) > 21) resolveRound(); else bjStand(); }
    function resolveRound() { bjState = 'ended'; updateScores(true); const pScore = getHandScore(playerHand); const dScore = getHandScore(dealerHand); const msg = document.getElementById('bj-status-msg'); let winAmount = 0; let resultType = 'Loss'; if (pScore > 21) { msg.innerText = "BUST!"; msg.style.color = "#e91e63"; resultType = 'Loss'; } else if (dScore > 21) { msg.innerText = "Dealer Bust! You Win!"; msg.style.color = "#00e701"; winAmount = bjWager * 2; resultType = 'Win'; } else if (pScore > dScore) { if(pScore === 21 && playerHand.length === 2) { msg.innerText = "BLACKJACK! (3:2)"; msg.style.color = "#ffd700"; winAmount = bjWager + (bjWager * 1.5); } else { msg.innerText = "YOU WIN!"; msg.style.color = "#00e701"; winAmount = bjWager * 2; } resultType = 'Win'; } else if (dScore > pScore) { msg.innerText = "Dealer Wins"; msg.style.color = "#e91e63"; resultType = 'Loss'; } else { msg.innerText = "PUSH (Tie)"; msg.style.color = "#b1bad3"; winAmount = bjWager; resultType = 'Push'; } if(winAmount > 0) { balance += winAmount; updateBalanceUI(); AudioEngine.win(); } else if (winAmount === 0 && resultType !== 'Push') { AudioEngine.lose(); } let profit = (resultType === 'Loss') ? -bjWager : (winAmount - bjWager); logGame('Blackjack', resultType, profit, bjWager, bjPfData); trackHistory(); document.getElementById('bj-controls').classList.add('hidden'); document.getElementById('btn-bj-deal').disabled = false; }
		function toggleCrazyMode() {
        AudioEngine.ui();
        isCrazyMode = document.getElementById('crazy-toggle').checked;
        
        // Update description dynamically
        const desc = document.getElementById('mode-desc');
        if(isCrazyMode) {
            if(battleType === 'standard') desc.innerText = "Crazy Classic: The player with the LOWEST total value wins.";
            else if(battleType === 'jackpot') desc.innerText = "Crazy Jackpot: Lower total value = HIGHER chance to win.";
            else if(battleType === 'point') desc.innerText = "Crazy Point Rush: The player who pulls the LOWEST value wins the point.";
        } else {
            // Reset to normal text
            setBattleType(battleType); 
        }
    }
    // Init User System
    UserSystem.init();
		function finishBattlePoint(participants, totalCost, pfLogData, finalPoints, grandTotal) {
        let teamPoints = {}; 
        
        // Sum up team POINTS
        participants.forEach(part => {
            const pts = finalPoints[part.id] || 0;
            teamPoints[part.team] = (teamPoints[part.team] || 0) + pts;
        });

        let winningTeam = -1; 
        let maxPoints = -1; 
        let isDraw = false;

        // In Point Rush, High Points always wins (Crazy Mode only changes how you GET the points)
        for (const [team, points] of Object.entries(teamPoints)) {
            if (points > maxPoints) { 
                maxPoints = points; 
                winningTeam = team; 
                isDraw = false; 
            }
            else if (points === maxPoints) { 
                isDraw = true; 
            }
        }
        
        // Color Results
        participants.forEach(p => {
            const scoreEl = document.getElementById(`score-${p.id}`);
            if (isDraw) {
                scoreEl.style.border = "2px solid #ffd700"; 
            } else if (p.team == winningTeam) {
                scoreEl.classList.add('win-box'); 
            } else {
                scoreEl.classList.add('lose-box'); 
            }
        });
        
        finalizeBattle(winningTeam, isDraw, grandTotal, totalCost, participants, pfLogData);
    }
  		function finishBattleStandard(participants, totalCost, pfLogData, finalScores, grandTotal) {
        let teamScores = {}; 
        participants.forEach(part => {
            const score = finalScores[part.id] || 0;
            teamScores[part.team] = (teamScores[part.team] || 0) + score;
        });

        let winningTeam = -1; 
        let bestScore = isCrazyMode ? Infinity : -1; // Toggle Start
        let isDraw = false;

        for (const [team, score] of Object.entries(teamScores)) {
            if (isCrazyMode) {
                // LOWER IS BETTER
                if (score < bestScore) { bestScore = score; winningTeam = team; isDraw = false; }
                else if (score === bestScore) { isDraw = true; }
            } else {
                // HIGHER IS BETTER
                if (score > bestScore) { bestScore = score; winningTeam = team; isDraw = false; }
                else if (score === bestScore) { isDraw = true; }
            }
        }
        
        finalizeBattle(winningTeam, isDraw, grandTotal, totalCost, participants, pfLogData);
    }
</script>
</body>
</html>
